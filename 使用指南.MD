# Sage MCP 完整使用指南

## 🚀 从零开始使用 Sage MCP

本指南将带您完成从电脑重启到成功使用 Sage MCP 的全过程。

## 📋 前置要求

### 系统环境
- macOS、Linux 或 Windows (WSL2)
- Python 3.8 或更高版本
- Docker Desktop 已安装并运行
- Claude Code CLI 已安装
- Git 已配置

### API 密钥
- [SiliconFlow API Key](https://siliconflow.cn) - 用于向量嵌入和重排序

## 🔧 完整启动流程

### 第一步：系统环境检查

```bash
# 1. 检查 Python 版本
python3 --version
# 期望输出: Python 3.8.x 或更高

# 2. 检查 Docker 状态
docker --version
docker ps
# 期望输出: Docker 版本信息，且能看到容器列表（可能为空）

# 3. 检查 Claude Code
claude --version
# 期望输出: Claude Code 版本信息
```

### 第二步：启动 Docker 和数据库

```bash
# 1. 启动 Docker Desktop（如果还没启动）
# macOS: 打开 Docker.app
# Linux: sudo systemctl start docker

# 2. 进入 Sage 项目目录
cd "/Volumes/1T HDD/Sage"

# 3. 启动 PostgreSQL 数据库
docker-compose up -d postgres

# 4. 等待数据库就绪（约10-20秒）
sleep 15

# 5. 验证数据库状态
docker-compose ps
# 期望看到: sage-postgres-1 状态为 "Up"
```

### 第三步：启动 Sage MCP 服务器

```bash
# 1. 确保在 Sage 目录下
pwd
# 应该显示: /Volumes/1T HDD/Sage

# 2. 检查环境变量配置
cat .env | grep SILICONFLOW_API_KEY
# 确保已设置 API Key

# 3. 启动 MCP 服务器
python3 app/sage_mcp_server.py
```

**期望看到的启动日志：**
```
2025-01-13 15:30:00,000 - ConfigManager - INFO - 配置已加载
2025-01-13 15:30:00,100 - Database connected - Total memories: 82
INFO:     Started server process [12345]
INFO:     Uvicorn running on http://0.0.0.0:17800
```

### 第四步：验证服务状态

打开新的终端窗口：

```bash
# 1. 检查健康状态
curl http://localhost:17800/health

# 期望输出:
{
  "status": "healthy",
  "timestamp": "2025-01-13T15:30:30.000000",
  "memory_count": 82,
  "database": "connected"
}

# 2. 检查 MCP 工具
curl -X POST http://localhost:17800/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":"test","method":"tools/list","params":{}}'

# 应该看到 4 个工具: save_conversation, get_context, search_memory, get_memory_stats
```

### 第五步：配置 Claude Code

```bash
# 1. 查看当前 MCP 配置
claude mcp list

# 2. 如果没有 sage，添加它
claude mcp add -t http sage http://localhost:17800/mcp

# 3. 验证添加成功
claude mcp list
# 应该看到: sage: http://localhost:17800/mcp (HTTP)
```

### 第六步：测试记忆功能

在 Claude Code 中测试：

```bash
# 1. 打开 Claude Code（在任意目录）
cd ~
claude

# 2. 发送测试消息
"请使用 get_memory_stats 工具查看记忆统计"

# 3. 验证自动上下文注入
"根据我们之前的讨论，Sage MCP 有哪些主要功能？"
# Claude 应该能够基于历史记忆回答
```

## 🔍 故障排除

### 问题1：Docker 未启动

**症状：** `docker ps` 报错 "Cannot connect to the Docker daemon"

**解决方案：**
```bash
# macOS
open -a Docker

# Linux
sudo systemctl start docker
sudo systemctl enable docker
```

### 问题2：数据库连接失败

**症状：** MCP 服务器启动时报数据库连接错误

**解决方案：**
```bash
# 1. 检查容器状态
docker-compose ps

# 2. 查看数据库日志
docker-compose logs postgres

# 3. 重启数据库
docker-compose down
docker-compose up -d postgres
```

### 问题3：端口被占用

**症状：** "Address already in use" 错误

**解决方案：**
```bash
# 1. 查找占用端口的进程
lsof -i :17800

# 2. 结束进程（假设 PID 是 12345）
kill -9 12345

# 3. 或修改端口（在 .env 文件中）
SAGE_PORT=17801
```

### 问题4：API Key 错误

**症状：** 嵌入生成失败，返回 401 错误

**解决方案：**
```bash
# 1. 检查 API Key
echo $SILICONFLOW_API_KEY

# 2. 如果为空，设置它
export SILICONFLOW_API_KEY="sk-your-actual-key"

# 3. 或在 .env 文件中设置
echo 'SILICONFLOW_API_KEY=sk-your-actual-key' >> .env
```

## 📊 系统监控

### 实时日志查看

```bash
# 在 MCP 服务器运行的终端中可以看到实时日志

# 或查看日志文件（如果配置了）
tail -f logs/sage_mcp.log
```

### 性能监控

```bash
# 1. 查看内存使用
ps aux | grep sage_mcp_server

# 2. 查看数据库连接
docker exec sage-postgres-1 psql -U sage_user -d sage_memory -c "SELECT count(*) FROM pg_stat_activity;"

# 3. 查看记忆数量增长
curl -s http://localhost:17800/health | jq '.memory_count'
```

## 💡 使用技巧

### 1. 创建启动脚本

创建 `start_sage.sh`：
```bash
#!/bin/bash
echo "启动 Sage MCP 系统..."

# 启动 Docker
if ! docker ps &> /dev/null; then
    echo "启动 Docker..."
    open -a Docker  # macOS
    sleep 10
fi

# 启动数据库
echo "启动数据库..."
cd "/Volumes/1T HDD/Sage"
docker-compose up -d postgres
sleep 10

# 启动 MCP 服务器
echo "启动 MCP 服务器..."
python3 app/sage_mcp_server.py
```

### 2. 设置命令别名

在 `~/.zshrc` 或 `~/.bashrc` 中添加：
```bash
alias sage-start='cd "/Volumes/1T HDD/Sage" && ./start_sage.sh'
alias sage-status='curl -s http://localhost:17800/health | jq'
alias sage-logs='docker-compose logs -f'
```

### 3. 日常使用流程

```bash
# 早上开始工作
sage-start

# 检查状态
sage-status

# 使用 Claude Code（自动带记忆）
cd /path/to/any/project
claude

# 晚上结束工作（可选，保持运行也没问题）
# Ctrl+C 停止 MCP 服务器
# docker-compose down
```

## 🛡️ 安全建议

1. **API Key 保护**
   - 不要将 `.env` 文件提交到 Git
   - 定期更换 API Key
   - 使用环境变量而非硬编码

2. **数据安全**
   - 定期备份数据库
   - 对敏感对话使用 `--no-memory` 选项
   - 考虑加密数据库存储

3. **访问控制**
   - MCP 服务器仅监听本地地址
   - 不要暴露到公网
   - 使用防火墙规则保护端口

## 📈 性能优化

### 快速启动优化
```bash
# 预编译 Python 代码
python3 -m compileall /Volumes/1T\ HDD/Sage/

# 使用 Python 优化模式
python3 -O app/sage_mcp_server.py
```

### 内存优化
```bash
# 在 .env 中调整缓存大小
SAGE_CACHE_SIZE=1000  # 增加缓存
SAGE_CACHE_TTL=600    # 延长缓存时间
```

## 🎯 快速检查清单

启动后确认以下事项：

- [ ] Docker 正在运行
- [ ] PostgreSQL 容器状态为 "Up"
- [ ] MCP 服务器在 17800 端口监听
- [ ] 健康检查返回 "healthy"
- [ ] Claude Code 中已注册 sage 服务器
- [ ] 能够成功调用记忆工具
- [ ] 自动上下文注入工作正常

## 📞 获取帮助

如果遇到问题：

1. 查看详细日志
2. 参考故障排除章节
3. 检查 GitHub Issues
4. 提交新的 Issue

---

**祝您使用愉快！** 🎉

Sage MCP 让 Claude 拥有持久记忆，让每次对话都更有价值。