# MCPåè®®ä¿®å¤æŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2025-07-13 17:52:41  
**ä»»åŠ¡**: ä¿®å¤Claude Code MCPè¿æ¥é”™è¯¯ "Dynamic client registration failed: HTTP 404"

## ğŸ“‹ é—®é¢˜è¯Šæ–­

### é”™è¯¯ä¿¡æ¯
```
Sage MCP Server
Status: âœ˜ failed
URL: http://localhost:17800/mcp
Error: Dynamic client registration failed: HTTP 404
```

### æ ¹æœ¬åŸå› 
Claude Codeå°è¯•è¿›è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œæ—¶ï¼Œæ‰¾ä¸åˆ°å¿…è¦çš„MCPå‘ç°å’Œæ³¨å†Œç«¯ç‚¹ã€‚

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ æ ¹è·¯å¾„å‘ç°ç«¯ç‚¹
```python
@app.get("/")
async def root():
    """Root endpoint for MCP server discovery"""
    return {
        "mcp_version": "2024-11-05",
        "server": "sage-mcp-server",
        "endpoints": {
            "mcp": "/mcp",
            "health": "/health",
            "info": "/mcp/info",
            "schema": "/mcp/schema"
        }
    }
```

### 2. æ·»åŠ CORS OPTIONSæ”¯æŒ
```python
@app.options("/mcp")
async def mcp_options():
    """Handle OPTIONS request for CORS"""
    return Response(
        status_code=200,
        headers={
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "POST, OPTIONS",
            "Access-Control-Allow-Headers": "Content-Type",
        }
    )
```

### 3. æ·»åŠ åŠ¨æ€æ³¨å†Œç«¯ç‚¹
```python
@app.post("/mcp/register")
async def mcp_register(request: Dict[str, Any]):
    """Handle dynamic client registration"""
    return {
        "client_id": "sage-mcp-client",
        "client_secret": "not-required",
        "registration_access_token": "not-required",
        "registration_client_uri": f"http://localhost:17800/mcp/clients/sage-mcp-client"
    }
```

### 4. æ·»åŠ Well-Knownå‘ç°ç«¯ç‚¹
```python
@app.get("/mcp/.well-known/mcp-configuration")
async def mcp_well_known():
    """MCP discovery endpoint"""
    return {
        "mcp_version": "2024-11-05",
        "issuer": "http://localhost:17800",
        "mcp_endpoint": "http://localhost:17800/mcp",
        "registration_endpoint": "http://localhost:17800/mcp/register",
        "tools_endpoint": "http://localhost:17800/tools",
        "capabilities": {
            "tools": True,
            "resources": True,
            "prompts": False,
            "logging": True
        }
    }
```

## ğŸ“Š éªŒè¯æµ‹è¯•

### ç«¯ç‚¹å¯ç”¨æ€§æµ‹è¯•
```bash
# æ ¹è·¯å¾„
curl -s http://localhost:17800/
âœ… è¿”å›æœåŠ¡å™¨ä¿¡æ¯å’Œç«¯ç‚¹åˆ—è¡¨

# Well-knowné…ç½®
curl -s http://localhost:17800/mcp/.well-known/mcp-configuration
âœ… è¿”å›MCPé…ç½®ä¿¡æ¯

# OPTIONSè¯·æ±‚
curl -s -X OPTIONS http://localhost:17800/mcp -I
âœ… è¿”å›CORSå¤´ä¿¡æ¯
```

### MCPåè®®åŠŸèƒ½æµ‹è¯•
```bash
# å·¥å…·å‘ç°
curl -s -X POST http://localhost:17800/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "id": "1", "method": "tools/list", "params": {}}'
âœ… è¿”å›5ä¸ªå·¥å…·åˆ—è¡¨

# åˆå§‹åŒ–
curl -s -X POST http://localhost:17800/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "id": "1", "method": "initialize", "params": {}}'
âœ… è¿”å›åè®®èƒ½åŠ›ä¿¡æ¯
```

## ğŸ¯ å½“å‰çŠ¶æ€

### ç³»ç»ŸçŠ¶æ€
- âœ… PostgreSQLæ•°æ®åº“è¿è¡Œæ­£å¸¸
- âœ… Sage MCPæœåŠ¡å™¨åœ¨ http://localhost:17800 è¿è¡Œ
- âœ… æ‰€æœ‰å¿…è¦ç«¯ç‚¹å·²æ·»åŠ 
- âœ… MCPåè®®åŠŸèƒ½æ­£å¸¸

### Claude Codeæ³¨å†Œ
- âœ… HTTPæ–¹å¼å·²æ³¨å†Œ: `sage: http://localhost:17800/mcp (HTTP)`
- âœ… å¤‡ç”¨stdioåŒ…è£…å™¨å·²åˆ›å»º: `sage_mcp_stdio.py`

## ğŸš€ åç»­æ­¥éª¤

### ç«‹å³æµ‹è¯•
1. **åœ¨Claude Codeä¸­æ‰“å¼€æ–°çª—å£**
2. **è¾“å…¥ `/MCP` æŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€**
3. **å¦‚æœä»ç„¶æ˜¾ç¤ºé”™è¯¯ï¼Œå°è¯•ä»¥ä¸‹æ–¹æ³•**ï¼š

### å¤‡é€‰æ–¹æ¡ˆAï¼šä½¿ç”¨stdioæ–¹å¼
```bash
# åˆ é™¤HTTPæ³¨å†Œ
claude mcp remove sage

# ä½¿ç”¨stdioæ–¹å¼æ³¨å†Œ
cd "/Volumes/1T HDD/Sage"
claude mcp add sage "python3 sage_mcp_stdio.py"
```

### å¤‡é€‰æ–¹æ¡ˆBï¼šæ£€æŸ¥Claude Codeæ—¥å¿—
```bash
# æŸ¥çœ‹Claude Codeè¯¦ç»†æ—¥å¿—
tail -f ~/.config/claude/logs/claude.log
```

### å¤‡é€‰æ–¹æ¡ˆCï¼šæ‰‹åŠ¨æµ‹è¯•å·¥å…·è°ƒç”¨
åœ¨Claude Codeä¸­ç›´æ¥æµ‹è¯•ï¼š
```
è¯·ä½¿ç”¨get_memory_statså·¥å…·æŸ¥çœ‹å½“å‰çš„è®°å¿†ç»Ÿè®¡ä¿¡æ¯
```

## ğŸ“ æŠ€æœ¯è¯´æ˜

### MCPåè®®è¦æ±‚
1. **æœåŠ¡å‘ç°**: é€šè¿‡æ ¹è·¯å¾„å’Œwell-knownç«¯ç‚¹
2. **åŠ¨æ€æ³¨å†Œ**: æ”¯æŒå®¢æˆ·ç«¯åŠ¨æ€æ³¨å†Œï¼ˆå¯é€‰ï¼‰
3. **CORSæ”¯æŒ**: å…è®¸è·¨åŸŸè¯·æ±‚
4. **JSON-RPC 2.0**: ä¸¥æ ¼éµå¾ªåè®®è§„èŒƒ

### å®ç°ç»†èŠ‚
- æ·»åŠ äº†4ä¸ªæ–°ç«¯ç‚¹æ”¯æŒå®Œæ•´çš„MCPå‘ç°æµç¨‹
- ä¿æŒå‘åå…¼å®¹æ€§ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- æ”¯æŒHTTPå’Œstdioä¸¤ç§ä¼ è¾“æ–¹å¼

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¦‚æœHTTPæ–¹å¼ä»æœ‰é—®é¢˜**ï¼Œå»ºè®®ä½¿ç”¨stdioåŒ…è£…å™¨
2. **ç¡®ä¿é˜²ç«å¢™å…è®¸17800ç«¯å£**
3. **æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹å ç”¨ç«¯å£**

---

**ç»“è®º**: MCPåè®®æ”¯æŒå·²å¢å¼ºï¼Œæ·»åŠ äº†æ‰€æœ‰å¿…è¦çš„å‘ç°å’Œæ³¨å†Œç«¯ç‚¹ã€‚ç°åœ¨åº”è¯¥å¯ä»¥åœ¨Claude Codeä¸­æ­£å¸¸ä½¿ç”¨Sageè®°å¿†åŠŸèƒ½ã€‚