# æ–¹æ¡ˆä¸€å¤šå±‚Hookæ•°æ®æ•è·è¯¦ç»†æ‰§è¡Œè®¡åˆ’

**åˆ¶å®šæ—¶é—´:** 2025-07-26 21:51:07  
**æ›´æ–°æ—¶é—´:** 2025-07-26 22:01:03  
**åŸºäºæŠ¥å‘Š:** 2025-07-26_21-32-40_Sageè®°å¿†ç³»ç»Ÿæ•°æ®ä¸¢å¤±é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md  
**ç›®æ ‡:** è§£å†³Sageè®°å¿†ç³»ç»Ÿ90%æ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œå®ç°å®Œæ•´å·¥å…·è°ƒç”¨é“¾æ•è·

## ğŸ”„ é‡è¦æ›´æ–° (2025-07-26 22:01)

**ç”¨æˆ·çº§é…ç½®å’Œè·¨é¡¹ç›®å…±äº«éœ€æ±‚:**
- âœ… **Hooksé…ç½®çº§åˆ«:** ç”¨æˆ·çº§ (~/.claude/settings.json) 
- âœ… **ç°æœ‰Hooks:** UserPromptSubmit + Stop hooks å·²é…ç½®
- âœ… **Sage MCP:** ç”¨æˆ·çº§é…ç½®ï¼Œæ‰€æœ‰é¡¹ç›®å…±äº«
- âœ… **æ•°æ®åº“ç­–ç•¥:** ç»Ÿä¸€å­˜å‚¨ï¼Œè·¨é¡¹ç›®å…±äº«ä¼šè¯è®°å½•
- âœ… **å®‰å…¨çº§åˆ«:** æœ¬åœ°éƒ¨ç½²ï¼Œä¸ªäººä½¿ç”¨ï¼Œç®€åŒ–å®‰å…¨è¦æ±‚

## æ‰§è¡Œæ¦‚è§ˆ

```
å½“å‰çŠ¶æ€: 10%æ•°æ®ä¿å­˜ç‡ (åªæœ‰æ–‡æœ¬äº¤äº’)
ç›®æ ‡çŠ¶æ€: 95%æ•°æ®ä¿å­˜ç‡ (å®Œæ•´å·¥å…·è°ƒç”¨é“¾)

æ‰§è¡Œç­–ç•¥: æ¸è¿›å¼å‡çº§ï¼Œæœ€å°é£é™©ï¼Œæœ€å¤§å…¼å®¹æ€§
æ€»å·¥æœŸ: çº¦14-18å¤©
å…³é”®æˆåŠŸæŒ‡æ ‡: é›¶ä¸šåŠ¡ä¸­æ–­ + 95%æ•°æ®å®Œæ•´æ€§
```

## ä¿®æ­£è¯´æ˜

**é‡è¦æ›´æ­£:** åŸºäºå®˜æ–¹clarificationï¼ŒHooksé…ç½®æ–‡ä»¶æ˜¯ `settings.json` è€Œé `.claude.md`

```
âœ… **ç¡®è®¤çš„Hooksé…ç½®è·¯å¾„:**
â””â”€â”€ ~/.claude/settings.json        (ç”¨æˆ·çº§ - æ‰€æœ‰é¡¹ç›®å…±äº«)

ğŸ” **å½“å‰å·²é…ç½®çš„Hooks:**
- UserPromptSubmit: /Users/jet/Sage/hooks/scripts/sage_prompt_enhancer.py
- Stop: /Users/jet/Sage/hooks/scripts/sage_archiver.py

CLAUDE.md ç”¨é€”: è®°å¿†/ä¸Šä¸‹æ–‡æç¤ºæ–‡ä»¶ï¼Œä¸Hooksé…ç½®æ— å…³
```

## æ€»ä½“æ¶æ„è®¾è®¡

```
è·¨é¡¹ç›®å…±äº«çš„ç”¨æˆ·çº§Hookåä½œæœºåˆ¶:

PreToolUse Hook     PostToolUse Hook     Stop Hook
     â†“                    â†“                  â†“
 [å·¥å…·è°ƒç”¨å‰]          [å·¥å…·æ‰§è¡Œå]        [ä¼šè¯ç»“æŸ]
     â†“                    â†“                  â†“
 æ•è·å‚æ•°/ä¸Šä¸‹æ–‡      æ•è·ç»“æœ/é”™è¯¯      æ•´åˆå®Œæ•´æ•°æ®
     â†“                    â†“                  â†“
     â””â”€â”€â”€â”€â”€â”€â”€ æ•°æ®åä½œæœºåˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                ç”¨æˆ·çº§Sage MCP Server
                         â†“
              ç»Ÿä¸€PostgreSQL + å‘é‡åŒ–
              (æ‰€æœ‰é¡¹ç›®å…±äº«æ•°æ®åº“)
```

---

## é˜¶æ®µä¸€: åŸºç¡€è®¾æ–½éªŒè¯å’Œé…ç½®ä¼˜åŒ–

### æ ¸å¿ƒä»»åŠ¡ (å·²è°ƒæ•´ä¸ºç”¨æˆ·çº§é…ç½®)
1. **éªŒè¯ç°æœ‰ç”¨æˆ·çº§hooksé…ç½®**
   - âœ… å½“å‰çŠ¶æ€: å·²æ­£ç¡®é…ç½®åœ¨ `~/.claude/settings.json`
   - âœ… UserPromptSubmit: `/Users/jet/Sage/hooks/scripts/sage_prompt_enhancer.py`
   - âœ… Stop: `/Users/jet/Sage/hooks/scripts/sage_archiver.py`
   - ç›®æ ‡: éªŒè¯ä¸¤ä¸ªhooksæ­£å¸¸å·¥ä½œå¹¶ä¸ºæ–°hooksåšå‡†å¤‡

2. **è·¨é¡¹ç›®æ•°æ®å…±äº«æœºåˆ¶ä¼˜åŒ–**
   - å¯¹ç°æœ‰sage_archiver.pyå¢åŠ é¡¹ç›®æ ‡è¯†èƒ½åŠ›
   - ç¡®ä¿æ‰€æœ‰é¡¹ç›®å…±äº«åŒä¸€ä¸ªæ•°æ®åº“å®ä¾‹
   - ç®€åŒ–å®‰å…¨æ£€æŸ¥ï¼Œä¼˜åŒ–æ€§èƒ½

### å…·ä½“å®æ–½æ­¥éª¤

#### æ­¥éª¤1.1: éªŒè¯å½“å‰ç”¨æˆ·çº§hooksçŠ¶æ€
```bash
# åœ¨Claude Codeä¸­æ‰§è¡Œ
/hooks
# éªŒè¯æ˜¾ç¤º: UserPromptSubmit + Stop hooks
```

#### æ­¥éª¤1.2: é¡¹ç›®æ ‡è¯†èƒ½åŠ›å¢å¼º
å¯¹ç°æœ‰hooksæ·»åŠ é¡¹ç›®æ£€æµ‹å’Œæ ‡è¯†èƒ½åŠ›:
```python
# åœ¨sage_archiver.pyä¸­æ·»åŠ ï¼š
def get_project_identifier() -> str:
    """è·å–é¡¹ç›®æ ‡è¯†ç¬¦"""
    cwd = os.getcwd()
    project_name = os.path.basename(cwd)
    return f"{project_name}_{hashlib.md5(cwd.encode()).hexdigest()[:8]}"

def enhance_metadata_with_project(metadata: Dict) -> Dict:
    """ä¸ºå…ƒæ•°æ®æ·»åŠ é¡¹ç›®ä¿¡æ¯"""
    metadata['project_id'] = get_project_identifier()
    metadata['project_path'] = os.getcwd()
    return metadata
```

#### æ­¥éª¤1.3: ç®€åŒ–å®‰å…¨æ£€æŸ¥
ç”±äºæœ¬åœ°éƒ¨ç½²ä¸ªäººä½¿ç”¨ï¼Œç®€åŒ–security_utils.py:
```python
# ç®€åŒ–ç‰ˆæœ¬ï¼Œç§»é™¤è¿‡åº¦çš„å®‰å…¨æ£€æŸ¥
# ä¿ç•™åŸºæœ¬çš„è¾“å…¥éªŒè¯å’Œæ–‡ä»¶è·¯å¾„æ£€æŸ¥
class SimplifiedSecurityUtils:
    @staticmethod
    def validate_basic_input(input_str: str, max_length: int = 100000) -> str:
        if len(input_str) > max_length:
            return input_str[:max_length]
        return input_str
```

#### æ­¥éª¤1.4: è·¨é¡¹ç›®æ•°æ®åº“è¿æ¥éªŒè¯
ç¡®ä¿æ‰€æœ‰é¡¹ç›®ä½¿ç”¨åŒä¸€ä¸ªSage MCPæœåŠ¡å™¨:
```bash
# åœ¨ä¸åŒé¡¹ç›®ä¸­æµ‹è¯•
cd /path/to/project1 && echo "test" | claude
cd /path/to/project2 && echo "test" | claude
# éªŒè¯æ•°æ®éƒ½å­˜å‚¨åˆ°åŒä¸€ä¸ªæ•°æ®åº“
```

### é¢„æœŸäº§å‡º
- [x] éªŒè¯ç”¨æˆ·çº§hooksé…ç½®æ­£å¸¸å·¥ä½œ
- [x] å¢å¼ºé¡¹ç›®æ ‡è¯†å’Œè·¨é¡¹ç›®æ•°æ®å…±äº«èƒ½åŠ›
- [x] ç®€åŒ–å®‰å…¨æ£€æŸ¥ï¼Œä¼˜åŒ–æ€§èƒ½
- [x] ä¸ºæ–°hookså®ç°åšå¥½åŸºç¡€å‡†å¤‡

---

## é˜¶æ®µäºŒ: Stop Hookæ•°æ®æå–å¢å¼º

### é—®é¢˜è¯Šæ–­
å½“å‰ `sage_archiver.py` Lines 135-136, 150-151 å­˜åœ¨è‡´å‘½ç¼ºé™·:

```python
# å½“å‰æœ‰é—®é¢˜çš„ä»£ç 
if isinstance(content_item, dict) and content_item.get('type') == 'text':
    text_content.append(content_item.get('text', ''))
```

**é—®é¢˜:** åªæå–textç±»å‹ï¼Œå¿½ç•¥tool_useã€tool_resultç­‰90%çš„å…³é”®æ•°æ®

### æ”¹é€ ç›®æ ‡
1. **æ‰©å±•æ•°æ®æå–é€»è¾‘** - æ”¯æŒå®Œæ•´çš„contentç±»å‹
2. **ä¿æŒå‘åå…¼å®¹** - ç°æœ‰æ–‡æœ¬æå–åŠŸèƒ½ä¸å—å½±å“
3. **å¢å¼ºæ•°æ®ç»“æ„** - ä¸ºå·¥å…·è°ƒç”¨æ•°æ®é¢„ç•™å­˜å‚¨ç»“æ„
4. **æ€§èƒ½ä¼˜åŒ–** - é¿å…é‡å¤è§£ætranscriptæ–‡ä»¶

### æŠ€æœ¯å®ç°

#### æ­¥éª¤2.1: é‡æ„extract_last_conversationæ–¹æ³•
```python
def extract_complete_interaction_chain(self, transcript_path: str):
    """æå–å®Œæ•´çš„äº¤äº’é“¾æ•°æ®"""
    user_message = None
    assistant_message = None
    tool_calls = []
    tool_results = []
    
    for line in reversed(lines):
        entry = json.loads(line)
        content_list = entry.get('message', {}).get('content', [])
        
        for content_item in content_list:
            content_type = content_item.get('type')
            
            if content_type == 'text':
                # ä¿å­˜æ–‡æœ¬å†…å®¹ (ç°æœ‰é€»è¾‘)
                text_content.append(content_item.get('text', ''))
                
            elif content_type == 'tool_use':
                # ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯
                tool_calls.append({
                    'name': content_item.get('name'),
                    'parameters': content_item.get('input', {}),
                    'id': content_item.get('id')
                })
                
            elif content_type == 'tool_result':
                # ä¿å­˜å·¥å…·æ‰§è¡Œç»“æœ
                tool_results.append({
                    'tool_use_id': content_item.get('tool_use_id'),
                    'content': content_item.get('content'),
                    'is_error': content_item.get('is_error', False)
                })
    
    return {
        'user_input': user_message,
        'assistant_response': assistant_message,
        'tool_calls': tool_calls,
        'tool_results': tool_results
    }
```

#### æ­¥éª¤2.2: æ‰©å±•æ•°æ®å­˜å‚¨æ ¼å¼
```python
class EnhancedConversationData:
    def __init__(self):
        self.user_input: str = ""
        self.assistant_response: str = ""
        self.tool_calls: List[Dict] = []
        self.tool_results: List[Dict] = []
        self.metadata: Dict[str, Any] = {}
```

#### æ­¥éª¤2.3: å¢å¼ºsage_coreæ¥å£å…¼å®¹æ€§
- æ‰©å±•MemoryContentæ¥å£æ”¯æŒå·¥å…·è°ƒç”¨æ•°æ®
- ä¿®æ”¹save_memoryæ–¹æ³•å¤„ç†å¤æ‚æ•°æ®ç»“æ„
- ä¿æŒä¸ç°æœ‰å‘é‡åŒ–é€»è¾‘çš„å…¼å®¹æ€§

### é¢„æœŸæˆæœ
- Stop Hookèƒ½å¤Ÿæ•è·70-80%çš„äº¤äº’æ•°æ® (ç›¸æ¯”å½“å‰10%)
- ä¸ºPreToolUse/PostToolUse hooksæä¾›å‚è€ƒå®ç°
- éªŒè¯transcript.jsonlè§£æçš„æ­£ç¡®æ€§

---

## é˜¶æ®µä¸‰: PreToolUse Hookå®ç°

### è®¾è®¡ç›®æ ‡
æ•è·å·¥å…·è°ƒç”¨å‰çš„å®Œæ•´çŠ¶æ€ï¼Œä¸ºæ¯ä¸ªå·¥å…·è°ƒç”¨ç”Ÿæˆå”¯ä¸€è¿½è¸ªIDï¼Œå»ºç«‹è°ƒç”¨é“¾èµ·ç‚¹ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **å·¥å…·è°ƒç”¨æ‹¦æˆª**
   - åœ¨å·¥å…·æ‰§è¡Œå‰æ•è·è°ƒç”¨å‚æ•°
   - è®°å½•è°ƒç”¨ä¸Šä¸‹æ–‡å’Œç¯å¢ƒçŠ¶æ€
   - ç”Ÿæˆunique_call_idç”¨äºé“¾è·¯è¿½è¸ª

2. **æ•°æ®é‡‡é›†ç­–ç•¥**
   - è½»é‡çº§æ•°æ®æ•è· (éµå¾ªå®˜æ–¹è½»é‡çº§åŸåˆ™)
   - é¿å…é‡å‹æ•°æ®åº“æ“ä½œ
   - ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æˆ–å†…å­˜ç¼“å­˜å…±äº«æ•°æ®

3. **æ€§èƒ½è€ƒè™‘**
   - hookæ‰§è¡Œæ—¶é—´ < 50ms
   - ä¸é˜»å¡å·¥å…·æ­£å¸¸æ‰§è¡Œ
   - é”™è¯¯å¤„ç†ä¸å½±å“ä¸»æµç¨‹

### æŠ€æœ¯å®ç°

#### æ­¥éª¤3.1: åˆ›å»ºsage_pre_tool_capture.pyè„šæœ¬
```python
#!/usr/bin/env python3
"""
Sage PreToolUse Hook - å·¥å…·è°ƒç”¨å‰çŠ¶æ€æ•è·
"""
import json
import sys
import time
import uuid
from pathlib import Path

def main():
    # è¯»å–hookè¾“å…¥
    input_data = json.loads(sys.stdin.read())
    
    # ç”Ÿæˆå”¯ä¸€è°ƒç”¨ID
    call_id = str(uuid.uuid4())
    
    # æ•è·å·¥å…·è°ƒç”¨å‰çŠ¶æ€
    pre_call_data = {
        'call_id': call_id,
        'session_id': input_data.get('session_id'),
        'tool_name': input_data.get('tool_name'),
        'tool_parameters': input_data.get('tool_input', {}),
        'timestamp': time.time(),
        'cwd': input_data.get('cwd'),
        'context': input_data.get('context', '')
    }
    
    # ä¿å­˜åˆ°ä¸´æ—¶å­˜å‚¨
    temp_dir = Path('/tmp/sage_hooks')
    temp_dir.mkdir(exist_ok=True)
    
    temp_file = temp_dir / f"pre_{call_id}.json"
    with open(temp_file, 'w') as f:
        json.dump(pre_call_data, f)
    
    # è¾“å‡ºåˆ°Claude (å¯é€‰)
    print(json.dumps({
        "status": "captured",
        "call_id": call_id
    }))

if __name__ == "__main__":
    main()
```

#### æ­¥éª¤3.2: æ›´æ–°ç”¨æˆ·çº§settings.jsonæ·»åŠ PreToolUse Hook
```json
// åœ¨ ~/.claude/settings.json ä¸­æ·»åŠ ï¼š
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/jet/Sage/hooks/scripts/sage_pre_tool_capture.py"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      // ç°æœ‰é…ç½®ä¿æŒä¸å˜
    ],
    "Stop": [
      // ç°æœ‰é…ç½®ä¿æŒä¸å˜
    ]
  }
}
```

#### æ­¥éª¤3.3: è·¨é¡¹ç›®æ•°æ®å…±äº«æœºåˆ¶è®¾è®¡
é€‚åº”ç”¨æˆ·çº§é…ç½®çš„æ•°æ®å…±äº«ç­–ç•¥:
```python
# æ•°æ®å­˜å‚¨ç­–ç•¥è°ƒæ•´
class CrossProjectDataManager:
    def __init__(self):
        # ç”¨æˆ·çº§ä¸´æ—¶ç›®å½•ï¼Œæ‰€æœ‰é¡¹ç›®å…±äº«
        self.temp_dir = Path.home() / '.sage_hooks_temp'
        self.temp_dir.mkdir(exist_ok=True)
    
    def store_pre_call_data(self, call_data: Dict) -> str:
        # æ·»åŠ é¡¹ç›®ä¿¡æ¯åˆ°æ•°æ®ä¸­
        call_data['project_id'] = self.get_current_project_id()
        call_data['project_path'] = os.getcwd()
        
        call_id = str(uuid.uuid4())
        file_path = self.temp_dir / f"pre_{call_id}.json"
        
        with open(file_path, 'w') as f:
            json.dump(call_data, f)
        
        return call_id
```
- ä½¿ç”¨ `~/.sage_hooks_temp/` ç”¨æˆ·çº§ä¸´æ—¶ç›®å½•
- æ•°æ®åŒ…å«é¡¹ç›®æ ‡è¯†ä¿¡æ¯
- è·¨é¡¹ç›®å¯è§æ€§å’Œå…±äº«æ€§

### é¢„æœŸæ”¶ç›Š
- æ•è·å·¥å…·è°ƒç”¨æ„å›¾å’Œå‚æ•°
- ä¸ºPostToolUse hookæä¾›å…³è”æ•°æ®
- å»ºç«‹å®Œæ•´çš„å·¥å…·æ‰§è¡Œç”Ÿå‘½å‘¨æœŸè¿½è¸ª

---

## é˜¶æ®µå››: PostToolUse Hookå®ç°

### è®¾è®¡ç›®æ ‡
æ•è·å·¥å…·æ‰§è¡Œåçš„å®Œæ•´ç»“æœï¼Œå…³è”PreToolUseçš„è°ƒç”¨IDï¼Œå®Œæˆå·¥å…·è°ƒç”¨é“¾çš„é—­ç¯ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. **å·¥å…·ç»“æœæ•è·**
   - æ•è·å·¥å…·æ‰§è¡Œçš„è¾“å‡ºç»“æœ
   - è®°å½•æ‰§è¡ŒçŠ¶æ€(æˆåŠŸ/å¤±è´¥/è¶…æ—¶)
   - æ•è·é”™è¯¯ä¿¡æ¯å’Œå¼‚å¸¸å †æ ˆ

2. **è°ƒç”¨é“¾å…³è”**
   - è¯»å–PreToolUse hookå­˜å‚¨çš„unique_call_id
   - å°†æ‰§è¡Œå‰åæ•°æ®è¿›è¡Œå…³è”
   - ç”Ÿæˆå®Œæ•´çš„å·¥å…·è°ƒç”¨è®°å½•

3. **ç‰¹æ®Šå¤„ç†ZENå·¥å…·**
   - ZENå·¥å…·åŒ…å«AI-to-AIä¸“å®¶åˆ†æ
   - éœ€è¦ç‰¹åˆ«æå–AIåˆ†æç»“æœ
   - ä¿å­˜thinkingè¿‡ç¨‹å’Œexpert insights

### æŠ€æœ¯å®ç°

#### æ­¥éª¤4.1: åˆ›å»ºsage_post_tool_capture.pyè„šæœ¬
```python
#!/usr/bin/env python3
"""
Sage PostToolUse Hook - å·¥å…·æ‰§è¡Œåç»“æœæ•è·
"""
import json
import sys
import time
from pathlib import Path

def main():
    # è¯»å–hookè¾“å…¥
    input_data = json.loads(sys.stdin.read())
    
    # æŸ¥æ‰¾å¯¹åº”çš„PreToolUseæ•°æ®
    session_id = input_data.get('session_id')
    tool_name = input_data.get('tool_name')
    
    # æ•è·å·¥å…·æ‰§è¡ŒåçŠ¶æ€
    post_call_data = {
        'session_id': session_id,
        'tool_name': tool_name,
        'tool_output': input_data.get('tool_output', {}),
        'execution_time': input_data.get('execution_time_ms'),
        'is_error': input_data.get('is_error', False),
        'error_message': input_data.get('error_message', ''),
        'timestamp': time.time()
    }
    
    # ç‰¹æ®Šå¤„ç†ZENå·¥å…·
    if tool_name.startswith('mcp__zen__'):
        post_call_data['zen_analysis'] = extract_zen_analysis(input_data)
    
    # å…³è”PreToolUseæ•°æ®
    temp_dir = Path('/tmp/sage_hooks')
    for pre_file in temp_dir.glob(f"pre_*.json"):
        try:
            with open(pre_file, 'r') as f:
                pre_data = json.load(f)
            
            if (pre_data.get('session_id') == session_id and 
                pre_data.get('tool_name') == tool_name):
                
                # ç”Ÿæˆå®Œæ•´å·¥å…·è°ƒç”¨è®°å½•
                complete_record = {
                    'call_id': pre_data['call_id'],
                    'pre_call': pre_data,
                    'post_call': post_call_data
                }
                
                # ä¿å­˜å®Œæ•´è®°å½•
                complete_file = temp_dir / f"complete_{pre_data['call_id']}.json"
                with open(complete_file, 'w') as f:
                    json.dump(complete_record, f)
                
                # æ¸…ç†PreToolUseä¸´æ—¶æ–‡ä»¶
                pre_file.unlink()
                break
                
        except Exception as e:
            continue
    
    print(json.dumps({"status": "processed"}))

def extract_zen_analysis(input_data):
    """æå–ZENå·¥å…·çš„AIåˆ†æç»“æœ"""
    output = input_data.get('tool_output', {})
    return {
        'status': output.get('status'),
        'content': output.get('content'),
        'metadata': output.get('metadata', {}),
        'thinking_mode': output.get('thinking_mode'),
        'model_used': output.get('model_used')
    }

if __name__ == "__main__":
    main()
```

#### æ­¥éª¤4.2: å¢å¼ºæ•°æ®ç»“æ„
```python
class ToolCallRecord:
    def __init__(self):
        self.call_id: str = ""
        self.session_id: str = ""
        self.tool_name: str = ""
        self.pre_call: Dict = {}
        self.post_call: Dict = {}
        self.execution_time_ms: int = 0
        self.is_error: bool = False
        self.zen_analysis: Optional[Dict] = None
```

### é¢„æœŸæ”¶ç›Š
- å®Œæ•´æ•è·å·¥å…·æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸ
- ä¸ºStop Hookæä¾›ä¸°å¯Œçš„å·¥å…·è°ƒç”¨æ•°æ®
- ç‰¹åˆ«ä¿å­˜ZENå·¥å…·çš„AIåˆ†æè¿‡ç¨‹

---

## é˜¶æ®µäº”: æ•°æ®åä½œæœºåˆ¶å’Œé›†æˆæ•´åˆ

### è®¾è®¡ç›®æ ‡
æ•´åˆPreToolUseã€PostToolUseã€Stopä¸‰å±‚hooksçš„æ•°æ®ï¼Œå®ç°å®Œæ•´çš„äº¤äº’é“¾é‡æ„å’Œå­˜å‚¨ã€‚

### æ ¸å¿ƒæŒ‘æˆ˜ (è·¨é¡¹ç›®å…±äº«ç¯å¢ƒ)
1. **è·¨é¡¹ç›®æ•°æ®æ—¶åºåŒæ­¥**
   - ç¡®ä¿Pre/Post/Stop hooksæ•°æ®çš„æ­£ç¡®å…³è”
   - å¤„ç†ä¸åŒé¡¹ç›®å¹¶å‘å·¥å…·è°ƒç”¨çš„æ•°æ®éš”ç¦»
   - åŸºäºé¡¹ç›®æ ‡è¯†å’Œsession_idçš„æ•°æ®å…³è”

2. **è·¨é¡¹ç›®æ•°æ®èšåˆç­–ç•¥**
   - å°†åˆ†æ•£çš„hookæ•°æ®æŒ‰é¡¹ç›®åˆå¹¶ä¸ºå®Œæ•´è®°å½•
   - å»ºç«‹é¡¹ç›®ç»´åº¦çš„å·¥å…·è°ƒç”¨ä¸æ–‡æœ¬äº¤äº’æ˜ å°„
   - ç»Ÿä¸€æ•°æ®åº“ä¸­çš„å¤šé¡¹ç›®æ•°æ®ç®¡ç†

### æŠ€æœ¯å®ç°

#### æ­¥éª¤5.1: è·¨é¡¹ç›®æ•°æ®æ±‡èšå±‚è®¾è®¡
```python
class CrossProjectHookDataAggregator:
    def __init__(self):
        self.temp_dir = Path.home() / '.sage_hooks_temp'
        
    def aggregate_session_data(self, session_id: str, project_id: str = None) -> Dict:
        """èšåˆä¼šè¯çš„å®Œæ•´æ•°æ®ï¼Œæ”¯æŒé¡¹ç›®ç­›é€‰"""
        tool_records = []
        
        for complete_file in self.temp_dir.glob(f"complete_*.json"):
            with open(complete_file, 'r') as f:
                record = json.load(f)
                pre_call = record.get('pre_call', {})
                
                # æ£€æŸ¥session_idåŒ¹é…
                if pre_call.get('session_id') == session_id:
                    # å¦‚æœæŒ‡å®šäº†project_idï¼Œè¿›ä¸€æ­¥ç­›é€‰
                    if project_id is None or pre_call.get('project_id') == project_id:
                        tool_records.append(record)
        
        # æŒ‰æ—¶é—´æ’åº
        tool_records.sort(key=lambda x: x['pre_call']['timestamp'])
        
        return {
            'session_id': session_id,
            'project_id': project_id,
            'tool_call_chain': tool_records,
            'total_tools': len(tool_records),
            'aggregated_at': time.time()
        }
    
    def get_all_projects_in_session(self, session_id: str) -> List[str]:
        """è·å–æŸä¸ªä¼šè¯ä¸­æ¶‰åŠçš„æ‰€æœ‰é¡¹ç›®"""
        projects = set()
        for complete_file in self.temp_dir.glob(f"complete_*.json"):
            with open(complete_file, 'r') as f:
                record = json.load(f)
                pre_call = record.get('pre_call', {})
                if pre_call.get('session_id') == session_id:
                    projects.add(pre_call.get('project_id', 'unknown'))
        return list(projects)
```

#### æ­¥éª¤5.2: å¢å¼ºè·¨é¡¹ç›®Stop HookåŠŸèƒ½
```python
# åœ¨sage_archiver.pyä¸­é›†æˆè·¨é¡¹ç›®å·¥å…·è°ƒç”¨æ•°æ®
def enhance_conversation_with_cross_project_tools(self, session_id: str, 
                                                conversation_data: Dict) -> Dict:
    """ä½¿ç”¨è·¨é¡¹ç›®å·¥å…·è°ƒç”¨æ•°æ®å¢å¼ºå¯¹è¯è®°å½•"""
    aggregator = CrossProjectHookDataAggregator()
    current_project_id = self.get_current_project_id()
    
    # è·å–å½“å‰é¡¹ç›®çš„å·¥å…·è°ƒç”¨æ•°æ®
    tool_data = aggregator.aggregate_session_data(session_id, current_project_id)
    
    # è·å–è·¨é¡¹ç›®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    all_projects = aggregator.get_all_projects_in_session(session_id)
    
    # åˆå¹¶æ•°æ®
    enhanced_data = {
        **conversation_data,
        'tool_call_chain': tool_data.get('tool_call_chain', []),
        'metadata': {
            **conversation_data.get('metadata', {}),
            'project_id': current_project_id,
            'tool_calls_count': tool_data.get('total_tools', 0),
            'cross_project_session': len(all_projects) > 1,
            'session_projects': all_projects,
            'data_completeness': self.calculate_completeness(conversation_data, tool_data)
        }
    }
    
    return enhanced_data

def get_current_project_id(self) -> str:
    """è·å–å½“å‰é¡¹ç›®æ ‡è¯†ç¬¦"""
    cwd = os.getcwd()
    project_name = os.path.basename(cwd)
    return f"{project_name}_{hashlib.md5(cwd.encode()).hexdigest()[:8]}"
```

#### æ­¥éª¤5.3: å­˜å‚¨å±‚é€‚é…
```python
# æ‰©å±•MemoryContentæ¥å£
class EnhancedMemoryContent(MemoryContent):
    def __init__(self, user_input: str, assistant_response: str, 
                 tool_call_chain: List[Dict] = None, **kwargs):
        super().__init__(user_input, assistant_response, **kwargs)
        self.tool_call_chain = tool_call_chain or []
        
    def to_vectorizable_text(self) -> str:
        """ç”Ÿæˆç”¨äºå‘é‡åŒ–çš„æ–‡æœ¬"""
        # åŸºç¡€æ–‡æœ¬
        base_text = f"{self.user_input}\n{self.assistant_response}"
        
        # å·¥å…·è°ƒç”¨æ‘˜è¦
        tool_summary = []
        for tool in self.tool_call_chain:
            tool_name = tool.get('pre_call', {}).get('tool_name', 'unknown')
            tool_summary.append(f"Tool: {tool_name}")
        
        if tool_summary:
            base_text += f"\nTools used: {', '.join(tool_summary)}"
            
        return base_text
```

### é¢„æœŸæ•ˆæœ
- å®ç°95%æ•°æ®å®Œæ•´æ€§ç›®æ ‡
- å»ºç«‹å¯æ‰©å±•çš„hooksæ•°æ®å¤„ç†æ¶æ„
- ä¸ºæœªæ¥hooksåŠŸèƒ½æ‰©å±•å¥ å®šåŸºç¡€

---

## é˜¶æ®µå…­: é›†æˆæµ‹è¯•å’Œæ€§èƒ½ä¼˜åŒ–

### æµ‹è¯•ç­–ç•¥

#### åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
1. **ç«¯åˆ°ç«¯å·¥å…·è°ƒç”¨é“¾æ•°æ®æ•è·æµ‹è¯•**
   ```bash
   # æµ‹è¯•ç”¨ä¾‹1: ç®€å•å·¥å…·è°ƒç”¨
   æµ‹è¯•åœºæ™¯: Read -> Edit -> Bashåºåˆ—
   éªŒè¯ç‚¹: æ¯ä¸ªå·¥å…·çš„Pre/Postæ•°æ®å®Œæ•´æ€§
   
   # æµ‹è¯•ç”¨ä¾‹2: ZENå·¥å…·å¤æ‚åˆ†æ
   æµ‹è¯•åœºæ™¯: /zen:debug + /zen:thinkdeepè°ƒç”¨
   éªŒè¯ç‚¹: AIåˆ†æè¿‡ç¨‹çš„å®Œæ•´è®°å½•
   
   # æµ‹è¯•ç”¨ä¾‹3: é”™è¯¯å¤„ç†
   æµ‹è¯•åœºæ™¯: å·¥å…·æ‰§è¡Œå¤±è´¥åœºæ™¯
   éªŒè¯ç‚¹: é”™è¯¯ä¿¡æ¯å’Œå †æ ˆçš„æ­£ç¡®æ•è·
   ```

2. **æ•°æ®å®Œæ•´æ€§éªŒè¯**
   ```python
   def verify_data_completeness(session_id: str) -> float:
       """è®¡ç®—æ•°æ®å®Œæ•´æ€§ç™¾åˆ†æ¯”"""
       transcript_tools = count_tools_in_transcript(session_id)
       captured_tools = count_captured_tools(session_id)
       return (captured_tools / transcript_tools) * 100 if transcript_tools > 0 else 0
   ```

#### æ€§èƒ½åŸºå‡†æµ‹è¯•
1. **Hookæ‰§è¡Œæ—¶é—´éªŒè¯**
   - ç›®æ ‡: å•ä¸ªhook < 100ms
   - æµ‹è¯•: è¿ç»­1000æ¬¡å·¥å…·è°ƒç”¨çš„æ€§èƒ½ç»Ÿè®¡

2. **å¹¶å‘å¤„ç†èƒ½åŠ›**
   - åœºæ™¯: åŒæ—¶å¤šä¸ªå·¥å…·è°ƒç”¨
   - éªŒè¯: æ•°æ®éš”ç¦»å’Œæ€§èƒ½å½±å“

#### å…¼å®¹æ€§æµ‹è¯•
1. **ç°æœ‰åŠŸèƒ½å›å½’æµ‹è¯•**
   - éªŒè¯RAGæµç¨‹ä¸å—å½±å“
   - ç¡®è®¤UserPromptSubmit hookæ­£å¸¸å·¥ä½œ
   - æ£€æŸ¥æ•°æ®åº“å­˜å‚¨åŠŸèƒ½

2. **ä¸åŒå·¥å…·ç±»å‹å…¼å®¹æ€§**
   - æµ‹è¯•æ‰€æœ‰å¸¸ç”¨å·¥å…·(Read, Write, Bash, Glob, Grepç­‰)
   - éªŒè¯ZENå·¥å…·ç‰¹æ®Šå¤„ç†é€»è¾‘
   - ç¡®è®¤ç¬¬ä¸‰æ–¹å·¥å…·çš„hooksæ”¯æŒ

### ä¼˜åŒ–é‡ç‚¹

#### æ€§èƒ½ä¼˜åŒ–
1. **Hooksè„šæœ¬æ‰§è¡Œæ•ˆç‡**
   - å‡å°‘æ–‡ä»¶I/Oæ“ä½œ
   - ä¼˜åŒ–JSONåºåˆ—åŒ–æ€§èƒ½
   - ä½¿ç”¨å†…å­˜ç¼“å­˜å‡å°‘ç£ç›˜è®¿é—®

2. **ä¸´æ—¶æ•°æ®ç®¡ç†**
   ```python
   def cleanup_expired_temp_files():
       """æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶æ–‡ä»¶"""
       temp_dir = Path('/tmp/sage_hooks')
       cutoff_time = time.time() - 86400  # 24å°æ—¶
       
       for temp_file in temp_dir.glob('*.json'):
           if temp_file.stat().st_mtime < cutoff_time:
               temp_file.unlink()
   ```

#### å¯é æ€§å¢å¼º
1. **é”™è¯¯æ¢å¤æœºåˆ¶**
   - Hookæ‰§è¡Œå¤±è´¥çš„é‡è¯•é€»è¾‘
   - æ•°æ®æŸåçš„æ¢å¤ç­–ç•¥
   - ä¼˜é›…é™çº§å¤„ç†

2. **ç›‘æ§å’Œå‘Šè­¦**
   ```python
   class HookMonitor:
       def __init__(self):
           self.metrics = {
               'hook_executions': 0,
               'hook_failures': 0,
               'average_execution_time': 0,
               'data_completeness_rate': 0
           }
       
       def record_execution(self, hook_type: str, execution_time: float, success: bool):
           """è®°å½•hookæ‰§è¡ŒæŒ‡æ ‡"""
           self.metrics['hook_executions'] += 1
           if not success:
               self.metrics['hook_failures'] += 1
   ```

### æˆåŠŸæ ‡å‡†
- æ•°æ®æ•è·ç‡ >= 95%
- Hookæ‰§è¡Œå»¶è¿Ÿ < 100ms
- é›¶åŠŸèƒ½å›å½’é—®é¢˜
- ç³»ç»Ÿç¨³å®šè¿è¡Œ72å°æ—¶

---

## é˜¶æ®µä¸ƒ: ç”Ÿäº§éƒ¨ç½²å’Œç›‘æ§ä½“ç³»

### éƒ¨ç½²ç­–ç•¥

#### æ¸è¿›å¼å‘å¸ƒ
1. **é˜¶æ®µæ€§å¯ç”¨**
   ```
   ç¬¬1å¤©: å¯ç”¨åŸºç¡€é…ç½® + Stop Hookå¢å¼º
   ç¬¬2å¤©: å¯ç”¨PreToolUse Hook
   ç¬¬3å¤©: å¯ç”¨PostToolUse Hook
   ç¬¬4å¤©: å¯ç”¨å®Œæ•´æ•°æ®åä½œæœºåˆ¶
   ```

2. **å¿«é€Ÿå›é€€æœºåˆ¶**
   ```bash
   # ç´§æ€¥å›é€€è„šæœ¬
   #!/bin/bash
   # rollback_hooks.sh
   
   # å¤‡ä»½å½“å‰é…ç½®
   cp .claude/settings.json .claude/settings.json.backup
   
   # æ¢å¤åˆ°åŸºç¡€é…ç½®
   cp .claude/settings.json.safe .claude/settings.json
   
   # é‡å¯ç›¸å…³æœåŠ¡
   echo "Hooks rolled back to safe configuration"
   ```

#### é…ç½®ç®¡ç†
1. **ç‰ˆæœ¬æ§åˆ¶**
   - æ‰€æœ‰hooksé…ç½®çº³å…¥Gitç‰ˆæœ¬æ§åˆ¶
   - ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æ ‡è®°é…ç½®å˜æ›´
   - å»ºç«‹é…ç½®å˜æ›´å®¡æ‰¹æµç¨‹

2. **æ–‡æ¡£åŒ–**
   ```markdown
   # Hooksé…ç½®è¯´æ˜
   
   ## æ–‡ä»¶ä½ç½®
   - ä¸»é…ç½®: .claude/settings.json
   - å¤‡ä»½é…ç½®: .claude/settings.json.safe
   
   ## Hookè„šæœ¬
   - PreToolUse: hooks/scripts/sage_pre_tool_capture.py
   - PostToolUse: hooks/scripts/sage_post_tool_capture.py
   - Stop: hooks/scripts/sage_archiver.py
   
   ## æ•…éšœæ’é™¤
   1. æ£€æŸ¥hooksæ³¨å†ŒçŠ¶æ€: `/hooks`
   2. æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—: hooks/logs/
   3. éªŒè¯ä¸´æ—¶æ–‡ä»¶: /tmp/sage_hooks/
   ```

### ç›‘æ§ä½“ç³»å»ºè®¾

#### æ€§èƒ½ç›‘æ§
```python
class HookPerformanceMonitor:
    def __init__(self):
        self.metrics_file = Path('hooks/logs/performance_metrics.json')
    
    def record_metrics(self):
        """è®°å½•æ€§èƒ½æŒ‡æ ‡"""
        metrics = {
            'timestamp': time.time(),
            'hook_execution_times': self.get_execution_times(),
            'data_completeness_rate': self.calculate_completeness(),
            'storage_usage': self.get_storage_usage(),
            'error_rate': self.calculate_error_rate()
        }
        
        with open(self.metrics_file, 'a') as f:
            f.write(json.dumps(metrics) + '\n')
```

#### ä¸šåŠ¡ç›‘æ§
1. **æ•°æ®å®Œæ•´æ€§ç›‘æ§**
   - å®æ—¶è®¡ç®—æ•°æ®æ•è·ç‡
   - å·¥å…·è°ƒç”¨é“¾å®Œæ•´æ€§æ£€æŸ¥
   - ZENå·¥å…·åˆ†æè´¨é‡è¯„ä¼°

2. **ç”¨æˆ·ä½“éªŒç›‘æ§**
   - Hookæ‰§è¡Œå¯¹å“åº”æ—¶é—´çš„å½±å“
   - å·¥å…·è°ƒç”¨æˆåŠŸç‡ç»Ÿè®¡
   - é”™è¯¯æ¢å¤æ•ˆæœè¯„ä¼°

#### å‘Šè­¦æœºåˆ¶
```python
class HookAlertManager:
    def __init__(self):
        self.alert_thresholds = {
            'data_completeness_rate': 0.90,  # 90%ä»¥ä¸‹å‘Šè­¦
            'hook_execution_time': 0.1,      # 100msä»¥ä¸Šå‘Šè­¦
            'error_rate': 0.05               # 5%ä»¥ä¸Šå‘Šè­¦
        }
    
    def check_and_alert(self, metrics: Dict):
        """æ£€æŸ¥æŒ‡æ ‡å¹¶å‘é€å‘Šè­¦"""
        for metric, threshold in self.alert_thresholds.items():
            if metrics.get(metric, 0) < threshold:
                self.send_alert(metric, metrics[metric], threshold)
```

### è¿ç»´è§„èŒƒ

#### æ—¥å¸¸ç»´æŠ¤
1. **æ–‡ä»¶æ¸…ç†**
   ```bash
   # å®šæœŸæ¸…ç†è„šæœ¬ (daily_cleanup.sh)
   #!/bin/bash
   
   # æ¸…ç†è¿‡æœŸä¸´æ—¶æ–‡ä»¶
   find /tmp/sage_hooks -name "*.json" -mtime +1 -delete
   
   # è½®è½¬æ—¥å¿—æ–‡ä»¶
   find hooks/logs -name "*.log" -size +100M -exec gzip {} \;
   
   # æ¸…ç†è€æ—§å¤‡ä»½
   find hooks/logs/backup -name "*.json" -mtime +30 -delete
   ```

2. **é…ç½®å¤‡ä»½**
   ```bash
   # é…ç½®å¤‡ä»½è„šæœ¬ (backup_config.sh)
   #!/bin/bash
   
   DATE=$(date +%Y%m%d_%H%M%S)
   BACKUP_DIR="hooks/config_backups"
   
   mkdir -p $BACKUP_DIR
   cp .claude/settings.json $BACKUP_DIR/settings_$DATE.json
   cp -r hooks/scripts $BACKUP_DIR/scripts_$DATE/
   ```

#### æ•…éšœæ¢å¤
1. **è¯Šæ–­æµç¨‹**
   ```bash
   # æ•…éšœè¯Šæ–­æ£€æŸ¥æ¸…å•
   1. æ£€æŸ¥hooksæ³¨å†ŒçŠ¶æ€: /hooks
   2. æŸ¥çœ‹æœ€è¿‘é”™è¯¯æ—¥å¿—: tail -f hooks/logs/archiver.log
   3. éªŒè¯ä¸´æ—¶æ–‡ä»¶çŠ¶æ€: ls -la /tmp/sage_hooks/
   4. æ£€æŸ¥æ•°æ®åº“è¿æ¥: æµ‹è¯•sage_coreåŠŸèƒ½
   5. éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•: python -m json.tool .claude/settings.json
   ```

2. **æ•°æ®æ¢å¤**
   ```python
   def recover_lost_data(session_id: str, backup_path: str):
       """ä»å¤‡ä»½æ¢å¤ä¸¢å¤±çš„æ•°æ®"""
       # ä»backupæ–‡ä»¶æ¢å¤åŸºç¡€å¯¹è¯æ•°æ®
       # é‡æ–°å¤„ç†transcript.jsonlæå–å·¥å…·è°ƒç”¨
       # è¡¥å……å‘é‡åŒ–å’Œå­˜å‚¨
   ```

### æŒç»­æ”¹è¿›

#### æ•°æ®åˆ†æ
1. **æ•ˆæœè¯„ä¼°**
   - æ¯å‘¨æ•°æ®æ•è·æ•ˆæœåˆ†æ
   - ç”¨æˆ·åé¦ˆæ”¶é›†å’Œåˆ†æ
   - æ€§èƒ½è¶‹åŠ¿ç›‘æ§

2. **ä¼˜åŒ–è¯†åˆ«**
   ```python
   def analyze_hook_performance():
       """åˆ†æhookæ€§èƒ½æ•°æ®ï¼Œè¯†åˆ«ä¼˜åŒ–æœºä¼š"""
       # åˆ†ææ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
       # è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
       # è¯„ä¼°èµ„æºä½¿ç”¨æ•ˆç‡
   ```

#### åŠŸèƒ½æ¼”è¿›
1. **åŸºäºä½¿ç”¨æƒ…å†µä¼˜åŒ–**
   - æ ¹æ®å·¥å…·ä½¿ç”¨é¢‘ç‡è°ƒæ•´hookä¼˜å…ˆçº§
   - ä¼˜åŒ–å¸¸ç”¨å·¥å…·çš„æ•°æ®æ•è·é€»è¾‘
   - æ‰©å±•ç‰¹æ®Šå·¥å…·çš„æ”¯æŒ

2. **ä¸å®˜æ–¹æ›´æ–°åŒæ­¥**
   - è·Ÿè¸ªClaude Codeå®˜æ–¹hooksåŠŸèƒ½æ›´æ–°
   - é€‚é…æ–°çš„hookç±»å‹å’ŒåŠŸèƒ½
   - ä¿æŒä¸æœ€ä½³å®è·µçš„ä¸€è‡´æ€§

### æœ€ç»ˆç›®æ ‡è¾¾æˆ

#### æ ¸å¿ƒæŒ‡æ ‡
- **æ•°æ®å®Œæ•´æ€§:** ä»10%æå‡è‡³95%
- **ç³»ç»Ÿç¨³å®šæ€§:** 99.9%å¯ç”¨æ€§
- **ç”¨æˆ·ä½“éªŒ:** é›¶æ„ŸçŸ¥çš„åŠŸèƒ½å¢å¼º
- **å¯ç»´æŠ¤æ€§:** å®Œå–„çš„ç›‘æ§å’Œè¿ç»´ä½“ç³»

#### é•¿æœŸä»·å€¼
- **çŸ¥è¯†ç§¯ç´¯:** å®Œæ•´çš„å¼€å‘è°ƒè¯•å†å²
- **æ•ˆç‡æå‡:** åŸºäºå†å²ç»éªŒçš„æ™ºèƒ½æç¤º
- **è´¨é‡ä¿éšœ:** å…¨é¢çš„é”™è¯¯æ¨¡å¼è¯†åˆ«
- **å›¢é˜Ÿåä½œ:** å…±äº«çš„æŠ€æœ¯çŸ¥è¯†åº“

---

## é£é™©ç®¡ç†å’Œåº”æ€¥é¢„æ¡ˆ

### ä¸»è¦é£é™©ç‚¹

#### æŠ€æœ¯é£é™©
1. **Hooksæ‰§è¡Œå¤±è´¥**
   - é£é™©: Hookè„šæœ¬å¼‚å¸¸å¯¼è‡´å·¥å…·è°ƒç”¨ä¸­æ–­
   - ç¼“è§£: å®Œå–„é”™è¯¯å¤„ç†ï¼Œç¡®ä¿ä¸»æµç¨‹ä¸å—å½±å“
   - åº”æ€¥: å¿«é€Ÿç¦ç”¨æœ‰é—®é¢˜çš„hook

2. **æ•°æ®å­˜å‚¨å¼‚å¸¸**
   - é£é™©: PostgreSQLè¿æ¥é—®é¢˜æˆ–å­˜å‚¨ç©ºé—´ä¸è¶³
   - ç¼“è§£: è¿æ¥æ± ç®¡ç†å’Œå­˜å‚¨ç›‘æ§
   - åº”æ€¥: é™çº§åˆ°æœ¬åœ°æ–‡ä»¶å­˜å‚¨

#### æ€§èƒ½é£é™©
1. **Hookæ‰§è¡Œå»¶è¿Ÿ**
   - é£é™©: Hookå¤„ç†æ—¶é—´è¿‡é•¿å½±å“ç”¨æˆ·ä½“éªŒ
   - ç¼“è§£: å¼‚æ­¥å¤„ç†å’Œæ€§èƒ½ç›‘æ§
   - åº”æ€¥: ä¸´æ—¶ç¦ç”¨æ€§èƒ½å½±å“å¤§çš„hook

2. **èµ„æºæ¶ˆè€—è¿‡é«˜**
   - é£é™©: ä¸´æ—¶æ–‡ä»¶ç§¯ç´¯æˆ–å†…å­˜æ³„æ¼
   - ç¼“è§£: å®šæœŸæ¸…ç†å’Œèµ„æºç›‘æ§
   - åº”æ€¥: é‡å¯ç›¸å…³æœåŠ¡

#### å…¼å®¹æ€§é£é™©
1. **Claude Codeæ›´æ–°**
   - é£é™©: å®˜æ–¹æ›´æ–°ç ´åç°æœ‰hooks
   - ç¼“è§£: è·Ÿè¸ªå®˜æ–¹æ›´æ–°å’Œå…¼å®¹æ€§æµ‹è¯•
   - åº”æ€¥: ç‰ˆæœ¬å›é€€å’Œé…ç½®è°ƒæ•´

### åº”æ€¥å“åº”æµç¨‹

```
æ•…éšœå‘ç”Ÿ
    â†“
å¿«é€Ÿè¯„ä¼°å½±å“èŒƒå›´
    â†“
æ˜¯å¦å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ
    â†“               â†“
   æ˜¯              å¦
    â†“               â†“
æ‰§è¡Œç´§æ€¥å›é€€      è®°å½•é—®é¢˜å¹¶è®¡åˆ’ä¿®å¤
    â†“               â†“
æ¢å¤åŸºç¡€åŠŸèƒ½      æ­£å¸¸æµç¨‹ä¿®å¤
    â†“               â†“
    â””â”€â”€â”€ é—®é¢˜åˆ†æå’Œæ”¹è¿› â”€â”€â”€â”˜
```

---

## æ€»ç»“

æœ¬æ‰§è¡Œè®¡åˆ’é€šè¿‡7ä¸ªé˜¶æ®µçš„æ¸è¿›å¼å®æ–½ï¼Œå°†å½»åº•è§£å†³Sageè®°å¿†ç³»ç»Ÿ90%æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚å…³é”®æˆåŠŸå› ç´ åŒ…æ‹¬:

1. **ä¸¥æ ¼éµå¾ªå®˜æ–¹æ ‡å‡†** - ä½¿ç”¨settings.jsoné…ç½®ï¼Œç¡®ä¿ä¸Claude Codeæ·±åº¦é›†æˆ
2. **æ¸è¿›å¼é£é™©æ§åˆ¶** - æ¯é˜¶æ®µéªŒè¯ï¼Œæœ€å°åŒ–å¯¹ç°æœ‰åŠŸèƒ½çš„å½±å“
3. **å®Œæ•´çš„ç›‘æ§ä½“ç³»** - å®æ—¶è·Ÿè¸ªæ•°æ®å®Œæ•´æ€§å’Œç³»ç»Ÿæ€§èƒ½
4. **å¯é çš„è¿ç»´æµç¨‹** - æ ‡å‡†åŒ–çš„ç»´æŠ¤å’Œåº”æ€¥å“åº”æœºåˆ¶

æ‰§è¡Œå®Œæˆåï¼ŒSageå°†ä»"ä¸¢å¤±90%ä»·å€¼ä¿¡æ¯"çš„çŠ¶æ€è½¬å˜ä¸º"å®Œæ•´ä¿å­˜å¼€å‘çŸ¥è¯†èµ„äº§"çš„å¼ºå¤§è®°å¿†ç³»ç»Ÿï¼Œä¸ºå¼€å‘æ•ˆç‡æå‡å¥ å®šåšå®åŸºç¡€ã€‚

---

## ğŸ”§ ç”¨æˆ·çº§é…ç½®å®æ–½è¡¥å……

### A. ç°çŠ¶ç¡®è®¤
âœ… **å·²ç¡®è®¤é…ç½®çŠ¶æ€:**
- ç”¨æˆ·çº§hooksé…ç½®: `~/.claude/settings.json`
- ç°æœ‰UserPromptSubmit + Stop hooksè¿è¡Œæ­£å¸¸
- Sage MCP serverç”¨æˆ·çº§éƒ¨ç½²ï¼Œè·¨é¡¹ç›®å…±äº«
- PostgreSQLæ•°æ®åº“ç»Ÿä¸€å­˜å‚¨ï¼Œæ‰€æœ‰é¡¹ç›®å…±äº«

### B. é…ç½®æœ€ç»ˆæ ‡å‡†åŒ–

#### B.1 å®Œæ•´çš„ ~/.claude/settings.json é…ç½®
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/jet/Sage/hooks/scripts/sage_pre_tool_capture.py"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": ".*", 
        "hooks": [
          {
            "type": "command",
            "command": "/Users/jet/Sage/hooks/scripts/sage_post_tool_capture.py"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command", 
            "command": "/Users/jet/Sage/hooks/scripts/sage_prompt_enhancer.py"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/jet/Sage/hooks/scripts/sage_archiver.py"
          }
        ]
      }
    ]
  },
  "mcp": {
    "servers": {
      "sage": {
        "command": "/Users/jet/Sage/start_sage_mcp.sh",
        "args": [],
        "env": {}
      }
    }
  }
}
```

#### B.2 è·¨é¡¹ç›®æ•°æ®è·¯å¾„æ ‡å‡†åŒ–
```bash
# åˆ›å»ºç”¨æˆ·çº§ç›®å½•ç»“æ„
mkdir -p ~/.sage_hooks_temp          # è·¨é¡¹ç›®ä¸´æ—¶æ•°æ®äº¤æ¢
mkdir -p ~/.sage_config              # ç”¨æˆ·çº§é…ç½®ç›®å½•
mkdir -p ~/Sage/hooks/logs          # ç»Ÿä¸€æ—¥å¿—ç›®å½• (å·²å­˜åœ¨)

# æ•°æ®åº“è·¯å¾„ (é€šè¿‡Sage MCPé…ç½®)
SAGE_DB_PATH="/Users/jet/Sage/data/sage_memory.db"
```

#### B.3 ç®€åŒ–å®‰å…¨é…ç½® (æœ¬åœ°éƒ¨ç½²ä¼˜åŒ–)
```python
# /Users/jet/Sage/hooks/security_utils.py ç®€åŒ–ç‰ˆ
class SimplifiedSecurityUtils:
    @staticmethod
    def validate_basic_input(input_str: str, max_length: int = 100000) -> str:
        """ç®€åŒ–çš„è¾“å…¥éªŒè¯ - æœ¬åœ°éƒ¨ç½²å‹å¥½"""
        if len(input_str) > max_length:
            return input_str[:max_length]
        return input_str
    
    @staticmethod
    def get_project_id(cwd: str = None) -> str:
        """è·å–é¡¹ç›®å”¯ä¸€æ ‡è¯†"""
        import os, hashlib
        cwd = cwd or os.getcwd()
        project_name = os.path.basename(cwd)
        return f"{project_name}_{hashlib.md5(cwd.encode()).hexdigest()[:8]}"
```

### C. ç«‹å³å¯æ‰§è¡Œçš„ä¸‹ä¸€æ­¥æ“ä½œ

#### C.1 é˜¶æ®µä¸€ä¼˜å…ˆä»»åŠ¡
```bash
# 1. éªŒè¯å½“å‰hooksçŠ¶æ€
claude /hooks

# 2. æµ‹è¯•è·¨é¡¹ç›®æ•°æ®å…±äº«
cd /Users/jet/TestProject1 && echo "test project 1" | claude
cd /Users/jet/TestProject2 && echo "test project 2" | claude

# 3. æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®åˆ†é¡¹ç›®ä¿å­˜
psql -d sage_memory -c "SELECT DISTINCT metadata->>'project_id' FROM memories ORDER BY created_at DESC LIMIT 10;"
```

#### C.2 Stop Hookæ•°æ®æå–å¢å¼º (å…³é”®ä¿®å¤)
ä¿®å¤ `/Users/jet/Sage/hooks/scripts/sage_archiver.py` 135-136è¡Œçš„æ•°æ®ä¸¢å¤±é—®é¢˜:

```python
# å½“å‰é—®é¢˜ä»£ç  (135-136è¡Œ):
if isinstance(content_item, dict) and content_item.get('type') == 'text':
    text_content.append(content_item.get('text', ''))

# ä¿®å¤åä»£ç :
if isinstance(content_item, dict):
    content_type = content_item.get('type')
    if content_type == 'text':
        text_content.append(content_item.get('text', ''))
    elif content_type == 'tool_use':
        # ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯
        tool_calls.append({
            'name': content_item.get('name'),
            'input': content_item.get('input', {}),
            'id': content_item.get('id')
        })
    elif content_type == 'tool_result':
        # ä¿å­˜å·¥å…·æ‰§è¡Œç»“æœ
        tool_results.append({
            'tool_use_id': content_item.get('tool_use_id'),
            'content': content_item.get('content'),
            'is_error': content_item.get('is_error', False)
        })
```

#### C.3 é¡¹ç›®æ ‡è¯†å¢å¼º
åœ¨ç°æœ‰hooksä¸­æ·»åŠ é¡¹ç›®è¯†åˆ«èƒ½åŠ›:

```python
# åœ¨ sage_archiver.py çš„ call_sage_save æ–¹æ³•ä¸­æ·»åŠ :
def enhance_metadata_with_project(self, metadata: Dict) -> Dict:
    """ä¸ºå…ƒæ•°æ®æ·»åŠ é¡¹ç›®ä¿¡æ¯"""
    import os, hashlib
    cwd = os.getcwd()
    project_name = os.path.basename(cwd)
    project_id = f"{project_name}_{hashlib.md5(cwd.encode()).hexdigest()[:8]}"
    
    metadata['project_id'] = project_id
    metadata['project_name'] = project_name
    metadata['project_path'] = cwd
    return metadata
```

### D. æˆåŠŸéªŒè¯æŒ‡æ ‡

å®Œæˆä¸Šè¿°é…ç½®åçš„éªŒè¯æ¸…å•:
- [ ] **è·¨é¡¹ç›®æ•°æ®å…±äº«**: ä¸åŒé¡¹ç›®ç›®å½•ä¸­çš„Claudeäº¤äº’éƒ½ä¿å­˜åˆ°åŒä¸€æ•°æ®åº“
- [ ] **é¡¹ç›®æ•°æ®éš”ç¦»**: æ•°æ®åŒ…å«æ­£ç¡®çš„project_idæ ‡è¯†
- [ ] **hooksæ­£å¸¸è§¦å‘**: åœ¨ä»»æ„é¡¹ç›®ä¸­éƒ½èƒ½çœ‹åˆ°hooksæ‰§è¡Œæ—¥å¿—
- [ ] **æ•°æ®å®Œæ•´æ€§æå‡**: ä»å½“å‰10%æå‡åˆ°åˆæ­¥70%ä»¥ä¸Š

è¿™æ ·ï¼ŒåŸºäºç”¨æˆ·çº§é…ç½®çš„è·¨é¡¹ç›®å…±äº«Sage Hooksç³»ç»Ÿå°±å¯ä»¥å¼€å§‹åˆæ­¥è¿è¡Œå’ŒéªŒè¯äº†ã€‚