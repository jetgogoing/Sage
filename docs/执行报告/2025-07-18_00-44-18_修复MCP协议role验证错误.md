# 修复MCP协议role验证错误

## 任务概述
- **目标**: 修复 `/sage:auto_context_injection` 指令导致的MCP协议验证错误
- **需求来源**: 用户在使用Claude CLI时遇到MCP error 0的协议验证失败

## 问题分析
错误信息显示：
```
MCP error 0: 1 validation error for PromptMessage
role
  Input should be 'user' or 'assistant' [type=literal_error, input_value='system', input_type=str]
```

**根本原因**: 在 `sage_mcp_stdio_single.py` 文件的 `auto_context_injection` 提示模板中，使用了 `role="system"`，但MCP协议的 `PromptMessage` 只接受 `role="user"` 或 `role="assistant"`。

## 修改范围与文件变动

### 修改文件：`/Users/jet/sage/sage_mcp_stdio_single.py`
- **修改行数**: 437-454行
- **修改原因**: 将不合规的 `role="system"` 改为 `role="assistant"`，并调整消息顺序

### 具体改动：
1. **原代码**:
   ```python
   messages = []
   if context and context != "没有找到相关的历史记忆。":
       messages.append(
           PromptMessage(
               role="system",  # 问题所在
               content=TextContent(
                   type="text",
                   text=f"基于以下相关历史记忆：\n\n{context}\n\n请回答用户的问题。"
               )
           )
       )
   
   messages.append(
       PromptMessage(
           role="user",
           content=TextContent(type="text", text=user_input)
       )
   )
   ```

2. **修改后代码**:
   ```python
   messages = []
   messages.append(
       PromptMessage(
           role="user",
           content=TextContent(type="text", text=user_input)
       )
   )
   
   if context and context != "没有找到相关的历史记忆。":
       messages.append(
           PromptMessage(
               role="assistant",  # 修复：改为assistant
               content=TextContent(
                   type="text",
                   text=f"基于以下相关历史记忆：\n\n{context}\n\n请回答用户的问题。"
               )
           )
       )
   ```

## 测试验证
- ✅ 语法检查通过：MCP服务器类成功导入，无语法错误
- ✅ 协议合规性：修改后的代码符合MCP协议要求

## 问题记录与解决方法
1. **权限问题**: 在测试过程中遇到 `/var/log/sage` 目录权限问题
   - **解决**: 使用环境变量 `SAGE_LOG_DIR="/Users/jet/sage/logs"` 指定正确的日志目录

## 后续建议
1. **建议更新启动脚本**: 在 `start_sage_mcp.sh` 中确保日志目录设置正确
2. **建议增加协议验证**: 在开发过程中增加MCP协议合规性检查
3. **建议测试完整流程**: 重新测试 `/sage:auto_context_injection` 指令的完整功能

## 修改影响
- **影响范围**: 仅影响 `auto_context_injection` 提示模板的消息格式
- **功能影响**: 不影响核心功能，只是调整了消息的role属性和顺序
- **兼容性**: 与MCP协议完全兼容

## 总结
成功修复了MCP协议验证错误，问题源于错误使用了 `role="system"`。修改后的代码符合MCP协议要求，用户应该能够正常使用 `/sage:auto_context_injection` 指令。