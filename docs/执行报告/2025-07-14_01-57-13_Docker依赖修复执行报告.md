# Docker 依赖修复执行报告

**时间：** 2025-07-14 01:57:13  
**任务：** 根据 OpenAI O3-mini 的建议修复 Python 依赖和 pgvector 扩展问题  
**执行结果：** ⚠️ 部分成功

## 任务概述

**需求来源：** 上一阶段修复了环境变量后，应用因缺少 Python 模块（requests、uvicorn）无法启动  
**目标：** 
1. 修复 Python 依赖问题
2. 安装 pgvector 扩展
3. 使 MCP 服务完全正常运行

## 修改范围与文件变动

### 1. 添加缺失的依赖
**文件：** `/Volumes/1T HDD/Sage/requirements.txt` (行 11)  
**修改原因：** 添加 requests 依赖（uvicorn 已存在）  
```
requests==2.31.0
```

### 2. 创建数据库初始化脚本
**文件：** `/Volumes/1T HDD/Sage/init-pgvector.sql` (新建)  
**修改原因：** 自动创建 pgvector 扩展  
```sql
CREATE EXTENSION IF NOT EXISTS vector;
SELECT * FROM pg_extension WHERE extname = 'vector';
```

### 3. 配置初始化脚本挂载
**文件：** `/Volumes/1T HDD/Sage/docker-compose-sage.yml` (行 48)  
**修改原因：** 让数据库容器自动执行初始化脚本  
```yaml
volumes:
  - ./init-pgvector.sql:/docker-entrypoint-initdb.d/01-init-pgvector.sql
```

### 4. 修复启动脚本
**文件：** `/Volumes/1T HDD/Sage/docker-entrypoint.sh` (行 111-114)  
**修改原因：** 设置正确的 Python 路径并简化启动命令  
```bash
cd /app
export PYTHONPATH=/app:$PYTHONPATH
exec python -m app.sage_mcp_server \
    || exec python app/sage_mcp_server.py
```

## 运行和测试输出摘要

### 构建过程
- ✅ 成功重建镜像（包含 requests 依赖）
- ✅ pip 安装显示：`Successfully installed ... requests-2.31.0 ...`

### 数据库初始化
```
postgres=# \dx
  Name   | Version |   Schema   |                     Description                      
---------+---------+------------+------------------------------------------------------
 plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language
 vector  | 0.8.0   | public     | vector data type and ivfflat and hnsw access methods
```
✅ pgvector 扩展成功安装！

### 应用启动日志
```
✅ Database port is reachable
✅ Python environment is ready
✅ Configuration validation passed
🚀 Starting Sage MCP Server...
Error importing Sage modules: No module named 'requests'
```

### 测试结果对比
| 测试项 | 之前 | 现在 | 状态 |
|--------|------|------|------|
| pgvector 扩展 | ❌ | ✅ | 已修复 |
| 数据库连接 | ✅ | ✅ | 正常 |
| MCP 服务 | ❌ | ❌ | 仍失败 |

## 问题记录与解决方法

### 已解决
1. **pgvector 扩展缺失**
   - 通过初始化脚本成功安装
   - 数据库现在支持向量存储

### 未解决
1. **Python 模块导入失败**
   - 尽管 requirements.txt 包含 requests
   - 尽管 pip 成功安装了 requests
   - 应用仍报告 "No module named 'requests'"
   - 疑似问题：
     - Python 路径配置问题
     - 多阶段构建导致的依赖丢失
     - 用户权限问题

## 根本原因分析

经过分析，问题可能出在：
1. **Python 包安装位置**：pip 安装到 `/root/.local/`，但 PATH 可能未正确设置
2. **导入链问题**：`sage_mcp_server.py` → `memory_interface` → `memory.py` → `requests`
3. **工作目录问题**：应用期望从特定目录运行

## 后续建议

### 立即修复方案
1. **简化 Dockerfile**
   - 使用单阶段构建
   - 全局安装 Python 包（不使用 --user）
   - 确保 PATH 包含 pip 包路径

2. **或者修改导入逻辑**
   - 在 sage_mcp_server.py 中延迟导入
   - 或创建一个不依赖 requests 的精简版本

3. **临时解决方案**
   - 直接在容器中手动安装：
     ```bash
     docker exec sage-docker-app pip install requests
     ```

## 总结

成功完成了部分修复：
- ✅ pgvector 扩展已安装并运行
- ✅ 数据库初始化流程正常
- ❌ Python 依赖问题仍未解决

核心的 Docker 基础设施和数据库层已经完全正常，但应用层的 Python 环境配置还需要进一步调整。建议采用更简单的 Dockerfile 构建方式来避免路径问题。

---

**执行人：** Claude Code  
**审核状态：** 需要继续修复 Python 环境  
**文档版本：** 1.0