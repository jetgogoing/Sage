# 修复 Sage MCP 跨项目连接问题深度分析 - 执行报告

## 任务概述
- **目标**：解决 Sage MCP 在 sage 项目中显示"正在连接"，在其他项目无法使用的问题
- **需求来源**：用户反馈 Sage MCP 无法像 Zen MCP 那样跨项目正常工作，怀疑是 HTTP+stdio 架构导致的

## 问题分析

### 现象描述
1. 在 sage 项目中，Sage MCP 一直显示"正在连接"状态
2. 在其他项目（如 haiku.rag）中无法连接到 Sage MCP
3. 同时 Zen MCP Server 可以正常跨项目工作

### 根本原因分析

#### 1. **过早关闭 HTTP Session**
- 原始代码在健康检查后立即调用 `cleanup()` 关闭了 HTTP session
- 日志显示：
  ```
  2025-07-15 16:29:48,910 - Backend health check passed
  2025-07-15 16:29:48,917 - Closed HTTP session
  ```
- stdio 服务器启动后立即退出，无法处理后续的 MCP 请求

#### 2. **目录依赖检查**
- 原始代码检查当前目录是否包含 `sage_mcp_stdio.py`：
  ```python
  if not os.path.exists("sage_mcp_stdio.py"):
      logger.warning("Not running from Sage directory, some features may not work")
  ```
- 这限制了跨项目使用的能力

#### 3. **HTTP+stdio 架构的复杂性**
- **Zen MCP**：纯 stdio 实现，直接处理请求
- **Sage MCP**：stdio → HTTP → Docker，增加了多层复杂性
- 需要更精细的生命周期管理

## 修改范围与文件变动

### 1. 创建修复版本的 stdio 服务器
- 文件：`/Users/jet/bin/sage-mcp/sage_mcp_stdio_v2_real_fix.py`（新建）
- 修改原因：
  - 移除目录检查限制
  - 修复生命周期管理问题
  - 改进日志处理，避免干扰 stdio 协议

### 2. 更新全局启动脚本
- 文件：`/Users/jet/bin/sage-mcp/start_sage_mcp_global.sh`（行 53）
- 修改原因：使用修复后的 Python 脚本

### 3. 主要代码改进
- **生命周期管理**：
  ```python
  # 只在真正结束时才清理
  finally:
      await server.cleanup()
  ```
- **日志处理**：
  ```python
  # 只记录到文件，避免干扰 stdio
  handlers=[logging.FileHandler('/tmp/sage_mcp_stdio_v2_fixed.log')]
  ```
- **移除目录限制**：删除了 `sage_mcp_stdio.py` 文件存在性检查

## 运行或测试的输出摘要

### 调查过程
1. 比较了 Zen MCP 和 Sage MCP 的实现差异
2. 分析了 HTTP+stdio 架构的影响
3. 检查了日志文件，发现过早关闭连接的问题
4. 测试了修复后的版本

### 关键发现
- Zen MCP 使用标准的 MCP SDK stdio 模式，简单直接
- Sage MCP 的 HTTP 代理模式需要保持连接池活跃
- 日志输出必须避免干扰 stdio 通信

## 问题记录与解决方法

### 问题 1：stdio 服务器过早退出
- **问题**：健康检查后立即关闭 HTTP session
- **解决**：只在服务器真正退出时才调用 cleanup()

### 问题 2：跨项目路径限制
- **问题**：检查当前目录限制了跨项目使用
- **解决**：移除目录检查，使用全局路径

### 问题 3：日志干扰 stdio 协议
- **问题**：日志输出到 stderr 可能干扰通信
- **解决**：只输出到日志文件

### 问题 4：初次尝试的配置错误
- **问题**：创建了循环软链接
- **解决**：删除错误链接，重新创建文件

## 架构对比分析

### Zen MCP Server
- **架构**：纯 stdio，直接集成 AI 模型调用
- **优势**：简单、无状态、易于跨项目使用
- **实现**：标准 MCP SDK 模式

### Sage MCP
- **架构**：stdio + HTTP + Docker
- **优势**：支持复杂后端、便于扩展、可复用现有 API
- **挑战**：需要精细的生命周期管理、更多的故障点

## 后续建议或注意事项

### 1. 部署建议
- 确保 Docker 容器持续运行
- 考虑将 Docker 服务设置为系统服务自动启动
- 定期检查健康状态

### 2. 架构优化建议
- **短期**：保持当前 HTTP+stdio 架构，但加强错误处理
- **长期**：考虑提供纯 stdio 模式选项，简化部署

### 3. 监控和调试
- 日志文件位置：`/tmp/sage_mcp_stdio_v2_fixed.log`
- 健康检查端点：`http://localhost:17800/health`
- Docker 日志：`docker logs sage-mcp-server`

### 4. 用户使用指南
1. 重启 Windsurf 以加载新配置
2. 确保 Docker 容器运行
3. 在任意项目中都可以使用 Sage MCP
4. 可以同时使用多个 MCP 服务（Sage、Zen 等）

### 5. 未来改进方向
- 添加自动重连机制
- 改进错误提示和用户反馈
- 考虑支持 WebSocket 传输层
- 优化启动时间和资源占用