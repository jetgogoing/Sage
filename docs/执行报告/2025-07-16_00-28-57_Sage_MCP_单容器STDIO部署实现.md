# Sage MCP 单容器 STDIO 部署实现报告

**执行时间**: 2025-07-16 00:28:57  
**执行人**: Claude  
**任务类型**: Docker 容器化部署  

## 任务概述

### 目标
将 Sage MCP 的所有核心功能模块与 PostgreSQL 数据库打包到单个 Docker 容器中，仅使用 STDIO 协议与 Claude Code 通讯，实现一键部署。

### 需求来源
- 用户要求简化部署流程
- 消除 HTTP 服务依赖
- 提高跨平台兼容性
- 符合 Anthropic MCP 标准

## 修改范围与文件变动

### 新增文件
1. **Dockerfile.single** (行 1-90)
   - 完整版 Dockerfile，包含所有依赖
   - 基于 python:3.10-slim
   - 集成 PostgreSQL 16 + pgvector

2. **Dockerfile.single.lite** (行 1-90)
   - 轻量版 Dockerfile
   - 不包含大型 ML 模型
   - 使用哈希向量化作为降级方案

3. **docker/single/init-db.sql** (行 1-15)
   - 数据库初始化脚本
   - 创建用户和数据库
   - 安装 pgvector 扩展

4. **docker/single/entrypoint.sh** (行 1-55)
   - 标准入口脚本
   - 管理服务启动顺序

5. **docker/single/entrypoint-lite.sh** (行 1-55)
   - 轻量版入口脚本
   - 改进的错误处理和日志管理

6. **sage_mcp_stdio_single.py** (行 1-500+)
   - 基于 v3 的容器优化版本
   - 日志路径调整为容器环境

7. **run_sage_single.sh** (行 1-30)
   - Unix/Linux/macOS 启动脚本
   - 处理 Docker 运行参数

8. **run_sage_single.bat** (行 1-30)
   - Windows 启动脚本
   - 跨平台兼容性支持

9. **requirements.txt** (行 1-25)
   - Python 依赖列表
   - 包含核心依赖和可选组件

10. **build_single_container.sh** (行 1-80)
    - 自动化构建脚本
    - 包含状态输出和错误处理

11. **README_DOCKER_SINGLE.md** (行 1-150)
    - 完整使用说明
    - 架构图和故障排查指南

### 修改文件
1. **sage_mcp_stdio_single.py** (行 42-51)
   - 日志路径从 `/tmp` 改为 `/var/log/sage`
   - 添加环境变量支持

## 运行和测试输出摘要

### Docker 镜像构建
```bash
# 构建轻量版成功
docker build -f Dockerfile.single.lite -t sage-mcp-single:lite .
# 镜像大小: 832MB
# 构建时间: ~5分钟
```

### 容器启动测试
- PostgreSQL 初始化正常
- 权限问题已修复
- STDIO 通道保持纯净

### 已知限制
1. 容器内 PostgreSQL 启动需要时间（~5秒）
2. 首次运行需要初始化数据库
3. 轻量版使用哈希向量化，精度略低

## 问题记录与解决方法

### 问题 1: PostgreSQL 日志权限
- **现象**: `/var/log/sage/postgresql.log: Permission denied`
- **原因**: 日志目录权限不正确
- **解决**: 在入口脚本中添加权限设置

### 问题 2: Poetry 依赖缺失
- **现象**: `poetry.lock not found`
- **原因**: 项目未使用 Poetry
- **解决**: 改用 requirements.txt

### 问题 3: 构建时间过长
- **现象**: 安装 transformers 和 torch 耗时超过 10 分钟
- **原因**: ML 模型依赖过重
- **解决**: 创建轻量版，使用哈希向量化

## 后续建议

### 优化方向
1. **多阶段构建优化**
   - 分离构建和运行时依赖
   - 减小最终镜像体积

2. **健康检查改进**
   - 添加更详细的健康检查逻辑
   - 包含应用层面的检查

3. **数据持久化**
   - 提供数据卷挂载示例
   - 支持备份和恢复

### 部署建议
1. **生产环境**
   - 使用命名卷进行数据持久化
   - 设置资源限制（CPU/内存）
   - 配置日志轮转

2. **开发环境**
   - 使用轻量版快速迭代
   - 启用调试日志
   - 映射本地代码目录

### 安全考虑
1. 数据库密码应通过环境变量传入
2. 限制容器网络访问
3. 定期更新基础镜像

## 总结

成功实现了 Sage MCP 单容器 STDIO 部署方案：

- ✅ 所有核心功能集成在单个容器
- ✅ 纯 STDIO 通讯，无需 HTTP
- ✅ 自动数据库初始化
- ✅ 跨平台部署脚本
- ✅ 轻量版可选方案

该方案大大简化了部署流程，提高了系统的可移植性和易用性。用户只需一个命令即可启动完整的 Sage MCP 服务，并通过 Claude Code 进行交互。