# Sageè®°å¿†ç³»ç»Ÿæ•°æ®ä¸¢å¤±é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

**æ‰§è¡Œæ—¶é—´:** 2025-07-26 21:32:40  
**ä»»åŠ¡ç±»å‹:** ç³»ç»Ÿæ¶æ„é—®é¢˜è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆè®¾è®¡  
**ä¸¥é‡ç¨‹åº¦:** è‡´å‘½ (Critical) - å½±å“æ•´ä¸ªé¡¹ç›®ä»·å€¼

## é—®é¢˜æ¦‚è¿°

### å‘ç°çš„è‡´å‘½é—®é¢˜
Sageè®°å¿†ç³»ç»Ÿç›®å‰åªä¿å­˜çº¦**10%**çš„æœ‰ä»·å€¼äº¤äº’æ•°æ®ï¼Œä¸¢å¤±äº†90%çš„å…³é”®å¼€å‘ä¿¡æ¯ï¼š
- âŒ å·¥å…·è°ƒç”¨å‚æ•°å’Œæ‰§è¡Œç»“æœ  
- âŒ Claudeçš„æ¨ç†è¿‡ç¨‹ (thinking blocks)
- âŒ ZENå·¥å…·çš„AI-to-AIä¸“å®¶åˆ†æ
- âŒ é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•traceback
- âŒ æ€§èƒ½æ•°æ®å’Œæ‰§è¡Œæ—¶é—´
- âŒ å¤šè½®å·¥å…·è°ƒç”¨çš„ä¸Šä¸‹æ–‡å…³è”

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. æ•°æ®æå–é€»è¾‘ç¼ºé™·
**æ–‡ä»¶:** `/Users/jet/Sage/hooks/scripts/sage_archiver.py`  
**é—®é¢˜ä½ç½®:** Lines 135-136, 150-151

```python
# å½“å‰çš„è‡´å‘½ç¼ºé™·ä»£ç 
if isinstance(content_item, dict) and content_item.get('type') == 'text':
    text_content.append(content_item.get('text', ''))
```

**é—®é¢˜åˆ†æ:**
- åªæå– `type == 'text'` çš„å†…å®¹
- å®Œå…¨å¿½ç•¥ `type == 'tool_use'`, `type == 'tool_result'` ç­‰å…³é”®æ•°æ®
- transcript.jsonl ä¸­åŒ…å«çš„ä¸°å¯Œå·¥å…·è°ƒç”¨ä¿¡æ¯è¢«ç›´æ¥ä¸¢å¼ƒ

#### 2. å­˜å‚¨æ¶æ„å±€é™æ€§
**æ–‡ä»¶:** `/Users/jet/Sage/sage_core/memory/manager.py`  
**é—®é¢˜ä½ç½®:** Line 55

```python
# è¿‡åº¦ç®€åŒ–çš„æ•°æ®åˆå¹¶
combined_text = f"{content.user_input}\n{content.assistant_response}"
```

**é—®é¢˜åˆ†æ:**
- åªå‘é‡åŒ–æœ€ç»ˆçš„æ–‡æœ¬äº¤æ¢
- ä¸¢å¤±äº†å·¥å…·è°ƒç”¨çš„è¯­ä¹‰ä¿¡æ¯
- æ— æ³•æ£€ç´¢åŸºäºå·¥å…·ä½¿ç”¨æ¨¡å¼çš„å†å²ç»éªŒ

## æŠ€æœ¯è°ƒç ”å‘ç°

### Claude Code Hooks èƒ½åŠ›åˆ†æ
åŸºäºå®˜æ–¹æ–‡æ¡£ `https://docs.anthropic.com/en/docs/claude-code/hooks`ï¼š

âœ… **å¯æ•è·çš„æ•°æ®ç±»å‹:**
- Tool usage (pre and post execution)
- User prompts and notifications  
- Agent stopping events
- Tool-specific inputs/outputs

âœ… **æ‰§è¡Œæ—¶æœº:**
- PreToolUse: å·¥å…·æ‰§è¡Œå‰
- PostToolUse: å·¥å…·æ‰§è¡Œå
- UserPromptSubmit: ç”¨æˆ·æäº¤æ—¶
- Stop: ä¼šè¯ç»“æŸæ—¶

âœ… **æ•°æ®è®¿é—®èƒ½åŠ›:**
- Session IDå’Œtranscriptè·¯å¾„
- å·¥å…·è°ƒç”¨çš„å®Œæ•´ä¸Šä¸‹æ–‡
- JSONæ ¼å¼çš„ç»“æ„åŒ–æ•°æ®

## è§£å†³æ–¹æ¡ˆæ¶æ„

### æ–¹æ¡ˆä¸€: å¤šå±‚Hookæ•°æ®æ•è· (æ¨è)

#### 1.1 å®ç° PreToolUse Hook
```bash
# æ–°å¢æ–‡ä»¶ä½ç½®
/Users/jet/Sage/hooks/scripts/sage_pre_tool_capture.py
```

**åŠŸèƒ½è®¾è®¡:**
- æ•è·å·¥å…·è°ƒç”¨å‰çš„å®Œæ•´çŠ¶æ€
- è®°å½•å·¥å…·å‚æ•°ã€ä¸Šä¸‹æ–‡ã€ç¯å¢ƒä¿¡æ¯
- ç”Ÿæˆå”¯ä¸€è°ƒç”¨IDå…³è”æ•´ä¸ªè°ƒç”¨é“¾

#### 1.2 å®ç° PostToolUse Hook  
```bash
# æ–°å¢æ–‡ä»¶ä½ç½®
/Users/jet/Sage/hooks/scripts/sage_post_tool_capture.py
```

**åŠŸèƒ½è®¾è®¡:**
- æ•è·å·¥å…·æ‰§è¡Œç»“æœã€é”™è¯¯ã€æ€§èƒ½æ•°æ®
- å…³è”PreToolUseçš„è°ƒç”¨ID
- ç‰¹åˆ«å¤„ç†ZENå·¥å…·çš„AIä¸“å®¶åˆ†æç»“æœ

#### 1.3 å¢å¼º Stop Hook (ç°æœ‰archiveræ”¹é€ )
**æ–‡ä»¶:** `/Users/jet/Sage/hooks/scripts/sage_archiver.py`

**æ”¹é€ é‡ç‚¹:**
```python
# æ›¿æ¢å½“å‰çš„text-onlyæå–é€»è¾‘
def extract_complete_interaction_chain(self, transcript_path: str):
    """æå–å®Œæ•´çš„äº¤äº’é“¾æ•°æ®"""
    for content_item in content_list:
        content_type = content_item.get('type')
        
        if content_type == 'text':
            # ä¿å­˜æ–‡æœ¬å†…å®¹
            text_content.append(content_item.get('text', ''))
            
        elif content_type == 'tool_use':
            # ä¿å­˜å·¥å…·è°ƒç”¨ä¿¡æ¯
            tool_calls.append({
                'name': content_item.get('name'),
                'parameters': content_item.get('input', {}),
                'id': content_item.get('id')
            })
            
        elif content_type == 'tool_result':
            # ä¿å­˜å·¥å…·æ‰§è¡Œç»“æœ
            tool_results.append({
                'tool_use_id': content_item.get('tool_use_id'),
                'content': content_item.get('content'),
                'is_error': content_item.get('is_error', False)
            })
```

### æ–¹æ¡ˆäºŒ: æ•°æ®å­˜å‚¨æ¶æ„é‡è®¾è®¡

#### 2.1 æ–°çš„æ•°æ®æ¨¡å‹è®¾è®¡

```python
# æ–°å¢æ¥å£å®šä¹‰
class EnhancedMemoryContent:
    session_id: str
    timestamp: datetime
    user_input: str
    assistant_response: str
    
    # æ–°å¢å­—æ®µ
    tool_calls: List[ToolCall]
    tool_results: List[ToolResult] 
    thinking_process: Optional[str]
    error_traces: List[ErrorTrace]
    performance_metrics: Dict[str, Any]
    interaction_metadata: Dict[str, Any]
```

#### 2.2 åˆ†å±‚å‘é‡åŒ–ç­–ç•¥

**æ–‡æœ¬å‘é‡:** ç”¨æˆ·è¾“å…¥ + åŠ©æ‰‹å›å¤  
**å·¥å…·å‘é‡:** å·¥å…·è°ƒç”¨æè¿° + å‚æ•° + ç»“æœæ‘˜è¦  
**æ¨ç†å‘é‡:** thinking blocks + é”™è¯¯åˆ†æè¿‡ç¨‹  
**ç»¼åˆå‘é‡:** èåˆå¤šä¸ªå‘é‡çš„åŠ æƒå¹³å‡

#### 2.3 æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•

```sql
-- åŸºç¡€è®°å¿†è¡¨ (ç°æœ‰)
memories (id, session_id, user_input, assistant_response, embedding, metadata, created_at)

-- æ–°å¢å·¥å…·è°ƒç”¨è¡¨
tool_interactions (
    id UUID PRIMARY KEY,
    memory_id UUID REFERENCES memories(id),
    tool_name VARCHAR(100),
    tool_parameters JSONB,
    tool_result JSONB,
    execution_time_ms INTEGER,
    is_error BOOLEAN,
    call_sequence INTEGER
);

-- æ–°å¢æ¨ç†è¿‡ç¨‹è¡¨  
thinking_processes (
    id UUID PRIMARY KEY,
    memory_id UUID REFERENCES memories(id),
    thinking_content TEXT,
    thinking_embedding VECTOR(4096),
    stage VARCHAR(50) -- pre_tool, post_tool, analysis, etc.
);
```

### æ–¹æ¡ˆä¸‰: å¼‚æ­¥æ•°æ®å¤„ç†æµæ°´çº¿

#### 3.1 å®æ—¶æ•°æ®é‡‡é›† (Hookå±‚)
- è½»é‡çº§æ•°æ®æ•è·ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
- å†™å…¥æ¶ˆæ¯é˜Ÿåˆ— (Redis/RabbitMQ)

#### 3.2 å¼‚æ­¥æ•°æ®å¤„ç† (Workerå±‚)  
- åå°workerå¤„ç†å®Œæ•´çš„æ•°æ®è§£æ
- å‘é‡åŒ–è®¡ç®—
- æ•°æ®æŒä¹…åŒ–

#### 3.3 æ€§èƒ½ç›‘æ§
- é‡‡é›†å»¶è¿Ÿç›‘æ§
- é˜Ÿåˆ—é•¿åº¦å‘Šè­¦
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ: ç´§æ€¥ä¿®å¤ (1-2å¤©)
- [x] **å·²å‘ç°é—®é¢˜:** è¯†åˆ«archiver.pyçš„text-onlyæå–ç¼ºé™·
- [ ] **å¿«é€Ÿä¿®å¤:** æ‰©å±•extract_last_conversationæ–¹æ³•æ”¯æŒå·¥å…·è°ƒç”¨
- [ ] **éªŒè¯æµ‹è¯•:** ä½¿ç”¨ZENå·¥å…·æµ‹è¯•å®Œæ•´æ•°æ®æ•è·

### ç¬¬äºŒé˜¶æ®µ: Hookå¢å¼º (3-5å¤©)
- [ ] **å®ç°PreToolUse Hook:** æ•è·å·¥å…·è°ƒç”¨å‰çŠ¶æ€
- [ ] **å®ç°PostToolUse Hook:** æ•è·æ‰§è¡Œç»“æœå’Œåˆ†æ
- [ ] **é›†æˆæµ‹è¯•:** éªŒè¯å¤šHookåè°ƒå·¥ä½œ

### ç¬¬ä¸‰é˜¶æ®µ: å­˜å‚¨æ¶æ„å‡çº§ (1å‘¨)
- [ ] **æ•°æ®åº“è¡¨ç»“æ„æ‰©å±•:** æ”¯æŒå·¥å…·è°ƒç”¨å’Œæ¨ç†æ•°æ®
- [ ] **å‘é‡åŒ–ç­–ç•¥å‡çº§:** å¤šå±‚æ¬¡å‘é‡åŒ–
- [ ] **æŸ¥è¯¢æ¥å£é‡æ„:** æ”¯æŒåŸºäºå·¥å…·ä½¿ç”¨æ¨¡å¼çš„æ£€ç´¢

### ç¬¬å››é˜¶æ®µ: æ€§èƒ½ä¼˜åŒ– (1å‘¨)  
- [ ] **å¼‚æ­¥å¤„ç†æµæ°´çº¿:** è§£è€¦æ•°æ®é‡‡é›†å’Œå¤„ç†
- [ ] **æ‰¹é‡å‘é‡åŒ–:** æå‡å‘é‡è®¡ç®—æ•ˆç‡
- [ ] **ç¼“å­˜ç­–ç•¥:** å¸¸ç”¨æŸ¥è¯¢ç»“æœç¼“å­˜

## é¢„æœŸæ•ˆæœ

### æ•°æ®ä¿å­˜å®Œæ•´æ€§
- **å½“å‰:** ~10% æ•°æ®ä¿å­˜ç‡
- **ç›®æ ‡:** ~95% æ•°æ®ä¿å­˜ç‡

### çŸ¥è¯†æ£€ç´¢èƒ½åŠ›  
- âœ… å¯ä»¥æ£€ç´¢"å¦‚ä½•ä½¿ç”¨ZEN debugå·¥å…·"
- âœ… å¯ä»¥æŸ¥æ‰¾"PostgreSQLè¿æ¥é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ"  
- âœ… å¯ä»¥å¤ç”¨"Dockeré…ç½®é”™è¯¯çš„æ’æŸ¥ç»éªŒ"
- âœ… å¯ä»¥å­¦ä¹ "æ€§èƒ½ä¼˜åŒ–çš„å…·ä½“å®æ–½æ­¥éª¤"

### å¼€å‘æ•ˆç‡æå‡
- å†å²è°ƒè¯•ç»éªŒçš„å¿«é€Ÿå¤ç”¨
- é”™è¯¯æ¨¡å¼çš„æ™ºèƒ½è¯†åˆ«
- å·¥å…·ä½¿ç”¨æœ€ä½³å®è·µçš„ç§¯ç´¯

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©
- **æ•°æ®é‡æš´å¢:** é¢„è®¡å­˜å‚¨éœ€æ±‚å¢åŠ 5-10å€
- **å‘é‡åŒ–æˆæœ¬:** è®¡ç®—èµ„æºéœ€æ±‚å¢åŠ 
- **æŸ¥è¯¢å¤æ‚åº¦:** å¤šè¡¨å…³è”çš„æ€§èƒ½å½±å“

### ç¼“è§£æªæ–½
- åˆ†çº§å­˜å‚¨ç­–ç•¥ (çƒ­/å†·æ•°æ®)
- å¼‚æ­¥å‘é‡åŒ–å¤„ç†
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- å®šæœŸæ•°æ®å½’æ¡£å’Œæ¸…ç†

## æŠ€æœ¯å®ç°å»ºè®®

### ç«‹å³å¯è¡Œçš„å¿«é€Ÿä¿®å¤
1. **ä¿®æ”¹ sage_archiver.py** ç¬¬135-151è¡Œçš„æå–é€»è¾‘
2. **æ‰©å±• MemoryContent æ¥å£** æ”¯æŒå·¥å…·è°ƒç”¨æ•°æ®
3. **éªŒè¯ç«¯åˆ°ç«¯æ•°æ®æµ** ç¡®ä¿ä¿®å¤ç”Ÿæ•ˆ

### é•¿æœŸæ¶æ„æ¼”è¿›
1. **æ¸è¿›å¼Hookå®ç°** é¿å…ç ´åç°æœ‰åŠŸèƒ½
2. **å‘åå…¼å®¹è®¾è®¡** ç°æœ‰æ•°æ®è¿ç§»ç­–ç•¥  
3. **ç›‘æ§å’Œå‘Šè­¦** å®æ—¶è·Ÿè¸ªæ”¹è¿›æ•ˆæœ

---

## ç»“è®º

è¿™æ˜¯ä¸€ä¸ªå½±å“é¡¹ç›®æ ¸å¿ƒä»·å€¼çš„è‡´å‘½é—®é¢˜ï¼Œä½†ä¹Ÿæ˜¯ä¸€ä¸ªæ˜ç¡®å¯è§£å†³çš„æŠ€æœ¯æŒ‘æˆ˜ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„æ¶æ„æ”¹è¿›ï¼ŒSageå¯ä»¥ä»"ä¸¢å¤±90%ä»·å€¼ä¿¡æ¯"è½¬å˜ä¸º"å®Œæ•´ä¿å­˜å¼€å‘çŸ¥è¯†èµ„äº§"çš„å¼ºå¤§è®°å¿†ç³»ç»Ÿã€‚

**å»ºè®®ä¼˜å…ˆçº§:** ğŸ”´ **æœ€é«˜ä¼˜å…ˆçº§** - ç«‹å³å¯åŠ¨ç¬¬ä¸€é˜¶æ®µä¿®å¤