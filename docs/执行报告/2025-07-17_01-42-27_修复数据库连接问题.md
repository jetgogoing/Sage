# 执行报告：修复数据库连接问题

## 任务概述
- **目标**：解决主机无法连接容器内 PostgreSQL 的问题
- **需求来源**：用户反馈 MCP 工具无法连接数据库（Connection refused）
- **执行时间**：2025-07-17 01:42:27

## 修改范围与文件变动

### 1. docker-compose.yml（行 12-13）
- **修改原因**：容器未对外暴露 PostgreSQL 端口
- **修改内容**：添加端口映射配置
  ```yaml
  ports:
    - "5432:5432"  # 映射 PostgreSQL 端口到主机
  ```

### 2. docker/single/entrypoint.sh（行 45-49）
- **修改原因**：PostgreSQL 仅监听容器内 localhost，无法接受外部连接
- **修改内容**：
  - 将 `listen_addresses` 从 `'localhost'` 改为 `'*'`
  - 添加 pg_hba.conf 规则允许外部连接：`host all all 0.0.0.0/0 md5`

## 所有运行或测试的输出摘要

1. **容器重启**：
   - 执行 `docker-compose down` 停止旧容器
   - 执行 `docker-compose up -d` 启动新容器
   - 容器启动成功，健康检查通过

2. **端口映射验证**：
   - `docker ps` 显示端口映射：`0.0.0.0:5432->5432/tcp`
   - Python socket 测试确认端口 5432 已开放

3. **数据库连接测试**：
   - 容器内部连接正常：`SELECT version()` 返回 PostgreSQL 15.13

## 问题记录与解决方法

### 问题分析
1. Docker 容器内的 PostgreSQL 没有对外开放端口
2. PostgreSQL 配置仅限容器内部的 localhost 监听
3. 从宿主机发起的连接请求被拒绝（Errno 61）

### 解决方案
采用了最快速、简单、稳定的方案一：
- 添加端口映射
- 修改 PostgreSQL 监听配置
- 无需重新构建镜像，只需重启容器

## 后续建议或注意事项

1. **安全性考虑**：
   - 当前配置允许所有 IP 连接（0.0.0.0/0），生产环境应限制 IP 范围
   - 考虑使用更强的认证方式替代 md5

2. **端口占用**：
   - 确保主机 5432 端口未被其他服务占用
   - 如有冲突，可修改为其他端口如 "15432:5432"

3. **MCP 工具连接**：
   - MCP 工具仍需配置正确的数据库连接参数
   - 可能需要更新环境变量或配置文件中的数据库连接信息

4. **持久化数据**：
   - 数据已通过 Docker volumes 持久化
   - 重启容器不会丢失数据