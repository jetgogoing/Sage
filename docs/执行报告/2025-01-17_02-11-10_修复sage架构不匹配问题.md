# 执行报告：修复 sage 架构不匹配问题

## 任务概述
- **目标**：解决 sage MCP 服务持续连接失败的深层问题
- **需求来源**：重建 Docker 镜像后，sage 连接仍然失败
- **执行时间**：2025-01-17 02:11:10

## 问题描述
尽管 Docker 容器正常运行且 PostgreSQL 服务健康，但 sage MCP 服务仍然报错 `[Errno 54] Connection reset by peer`。

## 深度分析发现

### 架构不匹配问题
通过深入调查发现了根本性的架构问题：

1. **设计意图**：Docker 容器设计为单容器架构，内部运行：
   - PostgreSQL 数据库
   - sage_mcp_stdio_single.py 服务

2. **实际情况**：存在两个 Python 进程：
   - **容器内进程**（PID 10470）：正确运行，与 PostgreSQL 在同一环境
   - **本地进程**（PID 24553）：由 MCP 配置启动，无法连接容器内的数据库

3. **根本原因**：`.mcp.json` 配置错误地指向本地文件系统，而不是使用容器内的服务

## 修改范围与文件变动

### 1. 停止本地进程
- **命令**：`pkill -f sage_mcp_stdio_single.py`
- **原因**：清理错误启动的本地进程

### 2. 修改 MCP 配置
- **文件**：`/Users/jet/sage/.mcp.json`
- **变更内容**：
```json
// 原配置：启动本地 Python 脚本
{
  "mcpServers": {
    "sage": {
      "type": "stdio",
      "command": "python",
      "args": ["/Users/jet/sage/sage_mcp_stdio_single.py"],
      "env": { ... }
    }
  }
}

// 新配置：连接到 Docker 容器内的服务
{
  "mcpServers": {
    "sage": {
      "type": "stdio",
      "command": "docker",
      "args": ["exec", "-i", "sage-mcp", "python", "-u", "/app/sage_mcp_stdio_single.py"]
    }
  }
}
```

## 技术细节

### Docker 架构说明
- 容器入口脚本 `entrypoint.sh` 最后执行：
  ```bash
  exec python -u /app/sage_mcp_stdio_single.py
  ```
- 这创建了一个持续运行的 stdio 服务
- MCP 应该连接到这个已运行的服务，而不是启动新实例

### 关键改进
- 使用 `docker exec -i` 连接到容器的 stdio 接口
- 移除了所有环境变量配置（容器内已设置）
- 简化了配置，符合单容器架构设计

## 后续建议

1. **立即操作**：
   - 重启 Claude 应用程序以加载新的 MCP 配置
   - 验证 sage 功能是否正常工作

2. **长期改进**：
   - 考虑添加健康检查确保容器服务正常
   - 在项目文档中明确说明架构设计
   - 添加故障排除指南

3. **监控建议**：
   - 定期检查 Docker 容器状态
   - 监控日志文件避免类似问题

## 总结
本次问题的根源是对单容器架构理解不足，导致配置错误。通过深度分析找到了架构不匹配的问题，并通过简单的配置修改解决了所有连接问题。这个案例强调了理解系统架构设计的重要性。