# 解决 Windsurf 跨项目连接 Sage MCP 问题 - 执行报告

## 任务概述
- **目标**：解决用户在 Windsurf 中切换到其他项目文件夹后无法连接 Sage MCP 服务的问题
- **需求来源**：用户反馈在 Windsurf 新建窗口进入别的项目文件夹之后，就无法连接 sage

## 问题分析

### 根本原因
1. MCP 启动脚本和相关文件都在 `/Users/jet/sage/` 项目目录中
2. 当切换到其他项目时，Claude Code 扩展无法访问这些文件
3. 虽然配置文件在全局位置 `~/.config/claude/claude_mcp_config.json`，但命令路径仍指向项目特定位置

### 调查过程
1. 检查了 MCP 配置文件路径
2. 分析了 Windsurf 的多窗口机制
3. 查看了日志文件，发现 stdio 服务正常启动但立即关闭
4. 确认 Docker 容器运行正常，问题仅在 stdio 接口层

## 修改范围与文件变动

### 1. 创建全局 MCP 目录
- 创建目录：`~/bin/sage-mcp/`

### 2. 复制必要文件
- `/Users/jet/sage/sage_mcp_stdio_v2.py` → `~/bin/sage-mcp/sage_mcp_stdio_v2.py`
- `/Users/jet/sage/start_sage_mcp_stdio_v2.sh` → `~/bin/sage-mcp/start_sage_mcp_stdio_v2.sh`

### 3. 创建新的全局启动脚本
- 文件：`~/bin/sage-mcp/start_sage_mcp_global.sh`（新建）
- 修改原因：创建可从任何项目访问的启动脚本，包含 Docker 容器状态检查

### 4. 更新全局配置
- 文件：`~/.config/claude/claude_mcp_config.json`（行 4）
- 修改原因：将命令路径从项目特定位置改为全局位置

### 5. 创建软链接
- 创建：`~/bin/sage-mcp` → `~/bin/sage-mcp/start_sage_mcp_global.sh`
- 修改原因：提供更简短的访问路径

## 运行或测试的输出摘要
- Docker 容器状态检查：sage-mcp-server 和 sage-postgres 运行正常
- 进程检查：确认没有独立的 sage MCP stdio 进程（按需启动）
- 日志分析：确认了多次启动尝试记录

## 问题记录与解决方法

### 问题 1：路径依赖
- **问题**：MCP 启动脚本路径依赖项目目录
- **解决**：将文件移到全局可访问位置

### 问题 2：O3 模型访问限制
- **问题**：深度分析时 O3 模型需要 API key
- **解决**：使用其他分析方法完成调查

## 后续建议或注意事项

1. **使用前确保 Docker 运行**：
   ```bash
   cd /Users/jet/sage
   docker-compose -f docker-compose.optimized.yml up -d
   ```

2. **重启 Windsurf**：修改配置后需要重启 Windsurf 和 Claude Code 扩展

3. **未来优化**：
   - 考虑将 Docker 服务也设置为系统服务，自动启动
   - 可以添加更多错误处理和自动恢复机制

4. **备份建议**：保留原始配置文件的备份，以便需要时恢复