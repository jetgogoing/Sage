# Sage 核心功能提取分析报告

## 任务概述
- **目标**：分析 sage_server.py 以了解需要提取到 sage_core 模块的核心功能
- **需求来源**：用户要求读取并分析代码以准备模块化重构
- **执行时间**：2025-07-15 18:42:03

## 核心功能分析

### 1. MCP 协议实现层
基于对 `sage_mcp_stdio_v2.py` 和 `app/sage_mcp_server.py` 的分析，核心 MCP 功能包括：

#### 1.1 stdio 服务器 (sage_mcp_stdio_v2.py)
- **协议处理**：实现 MCP stdio 协议，作为 HTTP 后端的代理
- **工具定义**：save_conversation、get_context、search_memory
- **提示模板**：auto_context_injection
- **HTTP 转发**：将 MCP 请求转发到 HTTP 后端服务器

#### 1.2 HTTP 服务器 (app/sage_mcp_server.py)
- **FastAPI 实现**：完整的 HTTP MCP 服务器
- **健康检查**：多层次的健康检查端点
- **MCP 端点**：/mcp 主端点处理所有 MCP 协议请求
- **工具实现**：实际的工具执行逻辑
- **自动注入**：上下文自动注入功能

### 2. 记忆系统核心 (memory.py & memory_interface.py)

#### 2.1 记忆接口抽象 (memory_interface.py)
- **IMemoryProvider**：抽象记忆提供者接口
- **MemoryProviderV1**：适配现有 memory.py 的实现
- **NullMemoryProvider**：禁用记忆时的空实现
- **工厂模式**：get_memory_provider() 函数

#### 2.2 记忆实现 (memory.py)
- **向量化**：使用 Qwen3-Embedding-8B 生成 4096 维向量
- **相似度搜索**：基于 pgvector 的余弦相似度检索
- **上下文生成**：使用 DeepSeek-V2.5 生成相关历史摘要
- **数据库操作**：PostgreSQL + pgvector 存储和检索

### 3. 配置管理系统 (config_manager.py)
- **统一配置**：SageConfig 数据类定义所有配置项
- **跨平台支持**：自动检测并使用平台特定的配置目录
- **配置迁移**：支持配置版本升级和迁移
- **环境变量**：支持通过环境变量覆盖配置

## 建议的模块化结构

### sage_core 模块应包含：

```
sage_core/
├── __init__.py
├── protocol/
│   ├── __init__.py
│   ├── mcp_types.py      # MCP 协议类型定义
│   ├── mcp_handler.py    # MCP 请求处理器基类
│   └── mcp_tools.py      # 工具定义和注册
├── memory/
│   ├── __init__.py
│   ├── interface.py      # IMemoryProvider 接口
│   ├── providers/
│   │   ├── __init__.py
│   │   ├── postgres.py   # PostgreSQL 实现
│   │   └── null.py       # 空实现
│   ├── embeddings.py     # 向量化功能
│   └── search.py         # 搜索和检索逻辑
├── config/
│   ├── __init__.py
│   ├── schema.py         # 配置数据类定义
│   ├── manager.py        # 配置管理器
│   └── defaults.py       # 默认配置值
└── utils/
    ├── __init__.py
    ├── logging.py        # 日志配置
    └── errors.py         # 错误处理
```

## 核心功能提取要点

### 1. 协议层分离
- 将 MCP 协议处理逻辑从具体实现中分离
- 定义清晰的工具接口和注册机制
- 支持多种传输方式（stdio、HTTP）

### 2. 记忆系统抽象
- 保持 IMemoryProvider 接口的稳定性
- 将数据库操作、向量化、搜索等功能模块化
- 支持多种记忆后端（PostgreSQL、内存、文件等）

### 3. 配置系统独立
- 配置定义与具体使用分离
- 支持配置验证和迁移
- 提供合理的默认值

### 4. 错误处理统一
- 定义统一的异常类型
- 实现重试和降级机制
- 提供详细的错误信息

## 依赖关系

### 外部依赖
- **MCP SDK**: mcp.server 相关模块
- **数据库**: psycopg2, pgvector
- **API**: aiohttp, requests
- **Web框架**: FastAPI, uvicorn
- **工具库**: numpy, pydantic

### 内部依赖
- memory_interface 依赖 memory
- sage_mcp_server 依赖 memory_adapter_v2
- 所有模块依赖 config_manager

## 潜在问题

1. **循环依赖**：需要仔细设计模块边界避免循环导入
2. **版本兼容**：需要保持向后兼容性
3. **性能考虑**：模块化可能带来额外的开销
4. **测试覆盖**：需要为每个模块编写独立的测试

## 下一步建议

1. **创建 sage_core 包结构**
2. **迁移核心类型定义**
3. **抽象 MCP 协议处理**
4. **重构记忆系统接口**
5. **统一配置管理**
6. **编写单元测试**
7. **更新现有代码以使用 sage_core**

## 总结

Sage 项目的核心功能主要包括：
- MCP 协议实现（stdio 和 HTTP）
- 记忆系统（向量化、存储、检索）
- 配置管理
- 工具定义和执行

通过将这些核心功能提取到 sage_core 模块，可以：
- 提高代码复用性
- 简化维护和测试
- 支持更灵活的部署方式
- 为未来扩展打下基础