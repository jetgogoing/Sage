# Sage 项目 MCP 改造完整计划

## 项目概述

将 Sage 智能记忆系统改造为符合 MCP（Model Context Protocol）标准的双模式架构，同时支持：
- **STDIO 模式**：供 Claude Code 等本地 IDE 插件使用
- **HTTP/SSE 模式**：供远程 API 调用和 MCP Connector 使用

## 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端层                               │
├─────────────────┬───────────────────┬───────────────────┤
│  Claude Code    │   MCP Connector   │   Custom Client   │
│  (STDIO)        │   (HTTP/SSE)      │   (HTTP API)      │
└────────┬────────┴─────────┬─────────┴─────────┬─────────┘
         │                  │                   │
         ▼                  ▼                   ▼
┌─────────────────┬─────────────────────┬───────────────┐
│   STDIO Server  │   HTTP/SSE Server   │  REST API      │
│  (MCP Protocol) │   (MCP Protocol)    │  (Legacy)      │
└────────┬────────┴─────────┬───────────┴───────┬───────┘
         │                  │                   │
         └──────────────────┴───────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │   sage_core   │
                    ├───────────────┤
                    │ • Memory Mgmt │
                    │ • Session     │
                    │ • Search      │
                    │ • Analysis    │
                    └───────┬───────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  PostgreSQL   │
                    │  + pgvector   │
                    └───────────────┘
```

### 核心模块结构

```
sage_core/
├── interfaces/          # 统一接口定义
│   ├── __init__.py
│   ├── core_service.py  # ISageService 主接口
│   └── memory.py        # IMemoryProvider 接口
├── memory/              # 记忆管理实现
│   ├── __init__.py
│   ├── manager.py       # 记忆管理器
│   ├── vectorizer.py    # 向量化处理
│   └── storage.py       # 存储适配器
├── session/             # 会话管理
│   ├── __init__.py
│   └── manager.py       # 会话生命周期管理
├── search/              # 搜索功能
│   ├── __init__.py
│   ├── semantic.py      # 语义搜索
│   └── hybrid.py        # 混合搜索策略
├── analysis/            # 智能分析
│   ├── __init__.py
│   ├── patterns.py      # 模式识别
│   └── insights.py      # 洞察生成
├── database/            # 数据库连接
│   ├── __init__.py
│   ├── connection.py    # 连接池管理
│   └── migrations.py    # 数据库迁移
├── config/              # 配置管理
│   ├── __init__.py
│   └── manager.py       # 统一配置
└── utils/               # 工具函数
    ├── __init__.py
    └── helpers.py       # 通用工具
```

## 实施阶段

### Phase 1: 核心业务层构建

#### 目标
建立独立的业务逻辑层，与协议层解耦

#### 任务列表
1. **创建 sage_core 包结构**
   ```bash
   mkdir -p sage_core/{interfaces,memory,session,search,analysis,database,config,utils}
   ```

2. **定义核心接口**
   - ISageService：主服务接口
   - IMemoryProvider：记忆存储接口
   - ISearchEngine：搜索引擎接口
   - IAnalyzer：分析器接口

3. **提取和重构现有功能**
   - 从 memory.py 提取记忆管理逻辑
   - 从 memory_interface.py 提取接口定义
   - 从 config_manager.py 提取配置管理
   - 统一错误处理和日志机制

4. **实现核心功能模块**
   - 记忆保存与检索
   - 向量化和相似度搜索
   - 会话管理和上下文维护
   - 智能分析和模式识别

### Phase 2: STDIO 服务器实现

#### 目标
构建完全符合 MCP 标准的 STDIO 服务器

#### 任务列表
1. **重构 STDIO 服务器**
   - 基于 sage_core 重写服务逻辑
   - 移除对 HTTP 后端的依赖
   - 实现完整的错误处理

2. **实现 MCP 工具集**
   ```
   Tools:
   ├── save_conversation    # 保存对话
   ├── get_context          # 获取上下文
   ├── search_memory        # 搜索记忆
   ├── manage_session       # 会话管理
   ├── analyze_memory       # 记忆分析
   └── generate_prompt      # 生成提示
   ```

3. **实现 MCP 提示系统**
   ```
   Prompts:
   ├── auto_context_injection    # 自动上下文注入
   ├── smart_prompt_generation   # 智能提示生成
   └── memory_based_completion   # 基于记忆的补全
   ```

### Phase 3: HTTP/SSE 服务器升级

#### 目标
支持 MCP Connector 的远程调用

#### 任务列表
1. **升级 HTTP 服务器**
   - 添加 SSE（Server-Sent Events）支持
   - 实现流式响应
   - 优化连接管理

2. **实现 MCP Connector 兼容接口**
   - 遵循 MCP HTTP 传输规范
   - 支持必需的请求头
   - 实现标准错误响应

3. **安全和性能优化**
   - CORS 配置
   - 请求限流
   - 响应缓存

### Phase 4: 认证系统实现

#### 目标
支持 OAuth 2.0 认证流程

#### 任务列表
1. **OAuth 2.0 实现**
   - 授权码流程
   - 令牌管理
   - 刷新机制

2. **集成到服务器**
   - HTTP 服务器认证中间件
   - 令牌验证
   - 权限控制

### Phase 5: 部署和文档

#### 目标
容器化部署和完善文档

#### 任务列表
1. **Docker 容器化**
   ```yaml
   services:
     sage-stdio:
       build: ./stdio
       volumes:
         - ./config:/app/config
     
     sage-http:
       build: ./http
       ports:
         - "17800:17800"
     
     postgres:
       image: pgvector/pgvector
       volumes:
         - sage-data:/var/lib/postgresql/data
   ```

2. **文档编写**
   - API 文档
   - 部署指南
   - 开发者指南
   - 示例代码

## 关键决策点

### 1. 数据库架构
- **保持现有模式**：确保向后兼容
- **添加索引优化**：提升查询性能
- **版本控制**：支持平滑升级

### 2. 向量化策略
- **保持 Qwen3-Embedding-8B**：已验证的模型
- **批量处理**：优化大量数据处理
- **缓存机制**：减少重复计算

### 3. 错误处理
- **统一错误码**：跨协议一致性
- **详细错误信息**：便于调试
- **优雅降级**：保证服务可用性

## 测试策略

### 单元测试
```
tests/
├── test_core/           # 核心功能测试
├── test_stdio/          # STDIO 协议测试
├── test_http/           # HTTP 协议测试
└── test_integration/    # 集成测试
```

### 性能基准
- 记忆保存：< 100ms
- 向量搜索：< 200ms
- 上下文生成：< 500ms

### 兼容性测试
- Claude Code 集成测试
- MCP Connector 验证
- 向后兼容性检查

## 监控和维护

### 日志策略
```python
logging:
  - level: INFO
    handlers: [file, console]
  - metrics: [latency, throughput, errors]
  - trace: [request_id, session_id]
```

### 健康检查
- 数据库连接状态
- 向量化服务可用性
- 内存使用情况
- 请求队列长度

## 下一步行动

1. **立即开始**：创建 sage_core 目录结构
2. **本周完成**：核心接口定义和基础框架
3. **持续迭代**：按照阶段计划逐步实施

我已经完成了详细的 Sage 项目 MCP 改造计划。这个计划涵盖了：

1. **双模式架构设计**：同时支持 STDIO（本地）和 HTTP/SSE（远程）
2. **五个实施阶段**：从核心重构到最终部署
3. **清晰的模块结构**：sage_core 作为业务核心
4. **具体的任务清单**：每个阶段的详细任务
5. **关键决策点**：技术选型和策略

需要我帮助您开始实施某个具体阶段吗？比如创建 sage_core 的基础结构或者定义核心接口？