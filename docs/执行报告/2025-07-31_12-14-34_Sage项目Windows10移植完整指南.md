# Sage项目Windows 10移植完整指南

## 任务概述

本指南旨在帮助Windows 10环境下的Claude Code CLI成功移植和部署Sage项目。基于当前macOS环境的Sage项目结构分析，提供详细的Windows适配方案。

## 项目架构概览

Sage是一个基于MCP协议的记忆管理系统，主要组件：
- **sage_core**: 核心记忆管理和数据库操作
- **sage_mcp_stdio_single.py**: MCP协议stdio接口
- **Docker容器**: 集成了PostgreSQL + pgvector + Python运行环境
- **Hooks系统**: Claude Code CLI集成钩子

## Windows 10环境准备

### 必备软件安装

```powershell
# 1. 安装Docker Desktop for Windows
# 下载地址: https://www.docker.com/products/docker-desktop/

# 2. 确保WSL2已启用（Docker Desktop依赖）
wsl --install

# 3. 安装Git for Windows
# 下载地址: https://git-scm.com/download/win

# 4. 确保Python 3.8+已安装
python --version

# 5. 安装Claude Code CLI（如已安装可跳过）
# 参考: https://docs.anthropic.com/en/docs/claude-code
```

## 关键适配修改

### 1. 文件路径适配

#### A. 环境变量配置文件 (.env)

```env
# Windows路径适配的.env配置
# 基础配置
SAGE_ENV=production
SAGE_LOG_LEVEL=INFO
SAGE_LOG_DIR=C:\sage\logs
SAGE_MAX_RESULTS=10

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=sage_memory
DB_USER=sage
DB_PASSWORD=sage123

# PostgreSQL 容器配置
PGDATA=/var/lib/postgresql/data
POSTGRES_PASSWORD=sage123

# SiliconFlow API密钥（必须配置）
SILICONFLOW_API_KEY=your_api_key_here

# MCP 服务配置
MCP_SERVER_NAME=sage
MCP_PROTOCOL_VERSION=2024-11-05

# Docker容器配置
CONTAINER_NAME=sage-mcp
DB_MAPPED_PORT=5432
```

#### B. Docker卷映射路径修改

修改 `docker-compose.yml` 中的卷映射：

```yaml
volumes:
  # 原路径修改为Windows路径
  - ./sage_core:/app/sage_core
  - ./sage_mcp_stdio_single.py:/app/sage_mcp_stdio_single.py
  # 数据持久化 - 使用Windows路径
  - sage-data:/var/lib/postgresql/data
  - sage-logs:/var/log/sage
  - sage-supervisor-logs:/var/log/supervisor
  # 备份目录 - 适配Windows路径
  - ./backups:/app/backups

volumes:
  sage-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/postgresql  # Docker Desktop会自动处理Windows路径
  sage-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/logs/sage
  sage-supervisor-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/logs/supervisor
```

#### C. 配置文件路径修改

需要修改的文件和对应的Windows路径适配：

1. **sage_core/config/manager.py** (第35-40行)
```python
# 修改家目录路径获取方式
home_config = Path.home() / '.sage' / 'config.json'  # Windows: C:\Users\用户名\.sage\config.json
```

2. **hooks配置文件路径**
```python
# hooks/scripts/config_manager.py 中的路径需要适配
# Windows下Claude Code CLI配置路径通常为：
# C:\Users\[用户名]\AppData\Roaming\Claude\claude_desktop\settings.json
```

### 2. Hooks系统Windows适配

#### A. 创建Windows批处理启动脚本

创建 `start_sage_windows.bat`:

```batch
@echo off
setlocal EnableDelayedExpansion

echo [启动] Sage MCP Server - Windows版本
echo.

REM 检查Docker是否运行
docker info >nul 2>&1
if %errorlevel% neq 0 (
    echo [错误] Docker未运行，请启动Docker Desktop
    pause
    exit /b 1
)

REM 检查.env文件
if not exist ".env" (
    echo [错误] .env文件不存在，请从.env.example复制并配置
    pause
    exit /b 1
)

REM 创建必要的目录
if not exist "data" mkdir data
if not exist "data\postgresql" mkdir data\postgresql
if not exist "data\logs" mkdir data\logs
if not exist "data\logs\sage" mkdir data\logs\sage
if not exist "data\logs\supervisor" mkdir data\logs\supervisor
if not exist "backups" mkdir backups

echo [启动] 构建和启动Docker容器...
docker-compose up -d --build

if %errorlevel% equ 0 (
    echo.
    echo [成功] Sage MCP Server已启动
    echo [信息] 容器名称: sage-mcp
    echo [信息] 数据库端口: 5432
    echo [信息] 日志查看: docker logs sage-mcp -f
    echo.
    echo [配置] 请将以下配置添加到Claude Code CLI的MCP设置中:
    echo {
    echo   "mcpServers": {
    echo     "sage": {
    echo       "command": "docker",
    echo       "args": ["exec", "-i", "sage-mcp", "python3", "/app/sage_mcp_stdio_single.py"]
    echo     }
    echo   }
    echo }
) else (
    echo [错误] 启动失败，请检查日志
    docker-compose logs
    pause
)

pause
```

#### B. Claude Code CLI配置适配

Windows下的Claude Code CLI MCP配置文件位置：
```
C:\Users\[用户名]\AppData\Roaming\Claude\claude_desktop\settings.json
```

配置内容：
```json
{
  "mcpServers": {
    "sage": {
      "command": "docker",
      "args": ["exec", "-i", "sage-mcp", "python3", "/app/sage_mcp_stdio_single.py"]
    }
  }
}
```

#### C. Hooks系统Windows适配脚本

创建 `setup_windows_hooks.bat`:

```batch
@echo off
echo [配置] Windows Hooks系统设置

REM 获取当前目录
for %%I in (.) do set "CURRENT_DIR=%%~fI"

echo [信息] 项目路径: %CURRENT_DIR%
echo.

echo [步骤1] 创建Hooks配置目录
if not exist "hooks\configs" mkdir hooks\configs

echo [步骤2] 复制Hooks配置文件
copy "hooks\new_hooks.json" "hooks\configs\sage_hooks.json" >nul

echo [步骤3] 生成Windows适配的Hooks配置
powershell -Command "& {
    $json = Get-Content 'hooks\configs\sage_hooks.json' | ConvertFrom-Json;
    $json.project_root = '%CURRENT_DIR%'.Replace('\', '/');
    $json.sage_mcp_path = '%CURRENT_DIR%\sage_mcp_stdio_single.py'.Replace('\', '/');
    $json | ConvertTo-Json -Depth 10 | Out-File 'hooks\configs\sage_hooks.json' -Encoding UTF8
}"

echo [完成] Hooks配置已生成
echo [信息] 配置文件位置: hooks\configs\sage_hooks.json

echo.
echo [下一步] 请手动将以下Hooks配置添加到Claude Code CLI设置中:
echo.
echo 配置文件位置: 
echo %APPDATA%\Claude\claude_desktop\settings.json
echo.
echo 添加以下Hooks配置:
type hooks\configs\sage_hooks.json

pause
```

### 3. Docker镜像适配

当前项目使用的Docker配置已经是跨平台兼容的：

- **基础镜像**: `pgvector/pgvector:pg15` - 支持多架构
- **Python环境**: 容器内使用Linux Python，无需Windows适配
- **文件系统**: Docker Desktop自动处理Windows路径映射

### 4. 数据库连接适配

数据库连接无需特殊适配，因为：
- PostgreSQL运行在Docker容器内（Linux环境）
- 连接通过localhost:5432访问
- 数据持久化通过Docker卷处理

### 5. 环境变量处理

Windows环境变量设置方式：

```batch
REM 临时设置（当前会话）
set SILICONFLOW_API_KEY=your_api_key
set SAGE_ENV=production

REM 或者使用PowerShell永久设置
powershell -Command "[System.Environment]::SetEnvironmentVariable('SILICONFLOW_API_KEY', 'your_api_key', 'User')"
```

## 完整部署流程

### Step 1: 环境准备

```powershell
# 1. 克隆项目到Windows
git clone [项目URL] C:\sage
cd C:\sage

# 2. 创建环境配置
copy .env.example .env
# 编辑.env文件，配置SILICONFLOW_API_KEY等必要参数

# 3. 创建必要目录
mkdir data, data\postgresql, data\logs, backups
```

### Step 2: Docker部署

```batch
# 1. 构建和启动容器
docker-compose up -d --build

# 2. 验证容器状态
docker ps
docker logs sage-mcp

# 3. 测试数据库连接
docker exec -it sage-mcp psql -U sage -d sage_memory -c "SELECT version();"
```

### Step 3: Claude Code CLI集成

```json
# 编辑 %APPDATA%\Claude\claude_desktop\settings.json
{
  "mcpServers": {
    "sage": {
      "command": "docker",
      "args": ["exec", "-i", "sage-mcp", "python3", "/app/sage_mcp_stdio_single.py"]
    }
  }
}
```

### Step 4: Hooks系统配置（可选）

```batch
# 1. 运行Hooks配置脚本
setup_windows_hooks.bat

# 2. 手动添加Hooks配置到Claude Code CLI设置
# 参考生成的hooks\configs\sage_hooks.json内容
```

### Step 5: 功能验证

```powershell
# 1. 测试MCP连接
# 在Claude Code CLI中执行：/zen get_status

# 2. 测试记忆保存
# 在Claude Code CLI中执行：/zen S "测试消息" "测试回复"

# 3. 测试记忆检索
# 在Claude Code CLI中执行：/zen get_context "测试"
```

## 常见问题解决

### 问题1: Docker Desktop启动失败
**解决方案**:
```powershell
# 确保WSL2已启用
wsl --install
wsl --set-default-version 2

# 重启Docker Desktop
```

### 问题2: 容器端口冲突
**解决方案**:
```yaml
# 修改docker-compose.yml中的端口映射
ports:
  - "5433:5432"  # 使用不同的主机端口
```

### 问题3: 文件权限问题
**解决方案**:
```powershell
# 确保Docker Desktop有足够权限访问项目目录
# 在Docker Desktop设置中添加项目路径到文件共享列表
```

### 问题4: 环境变量不生效
**解决方案**:
```batch
# 检查.env文件编码（应为UTF-8）
# 确保没有多余的空格或特殊字符
# 重启Docker容器使环境变量生效
docker-compose down && docker-compose up -d
```

### 问题5: MCP连接失败
**解决方案**:
```powershell
# 1. 检查容器状态
docker ps
docker logs sage-mcp

# 2. 验证MCP服务
docker exec -it sage-mcp python3 /app/sage_mcp_stdio_single.py

# 3. 检查Claude Code CLI配置路径
echo %APPDATA%\Claude\claude_desktop\settings.json
```

## 性能优化建议

### 1. Docker资源配置
```json
// Docker Desktop设置
{
  "memory": "4GB",
  "cpus": 2,
  "disk": "60GB"
}
```

### 2. 数据库调优
```sql
-- 适合Windows的PostgreSQL配置调整
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
SELECT pg_reload_conf();
```

### 3. 日志管理
```batch
REM 创建日志轮转脚本 rotate_logs.bat
forfiles /p "data\logs" /m "*.log" /d -7 /c "cmd /c del @path"
```

## 安全注意事项

1. **API密钥管理**: 确保.env文件不被提交到版本控制
2. **端口暴露**: 生产环境建议移除数据库端口映射
3. **文件权限**: 限制Hooks脚本的执行权限
4. **网络安全**: 考虑使用Docker内部网络而非端口映射

## 备份与恢复

### 备份脚本 (backup_windows.bat)
```batch
@echo off
set BACKUP_DIR=backups\%date:~0,4%-%date:~5,2%-%date:~8,2%_%time:~0,2%-%time:~3,2%-%time:~6,2%
mkdir %BACKUP_DIR%

echo [备份] 导出数据库...
docker exec sage-mcp pg_dump -U sage sage_memory > %BACKUP_DIR%\database.sql

echo [备份] 复制配置文件...
copy .env %BACKUP_DIR%\
copy docker-compose.yml %BACKUP_DIR%\

echo [完成] 备份已保存到: %BACKUP_DIR%
```

### 恢复脚本 (restore_windows.bat)
```batch
@echo off
set /p BACKUP_DIR="请输入备份目录名: "

echo [恢复] 停止容器...
docker-compose down

echo [恢复] 清理数据...
rmdir /s /q data\postgresql

echo [恢复] 启动容器...
docker-compose up -d

echo [恢复] 等待数据库就绪...
timeout /t 30

echo [恢复] 导入数据...
docker exec -i sage-mcp psql -U sage sage_memory < %BACKUP_DIR%\database.sql

echo [完成] 数据已恢复
```

## 监控与维护

### 健康检查脚本 (health_check_windows.bat)
```batch
@echo off
echo [检查] Sage系统健康状态

echo [容器状态]
docker ps --filter "name=sage-mcp" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo.
echo [数据库连接]
docker exec sage-mcp pg_isready -U sage -d sage_memory

echo.
echo [磁盘使用]
docker exec sage-mcp df -h /var/lib/postgresql/data

echo.
echo [内存使用]
docker stats sage-mcp --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

echo.
echo [最近日志]
docker logs sage-mcp --tail 10
```

## 更新与升级

### 更新脚本 (update_windows.bat)
```batch
@echo off
echo [更新] Sage项目更新

echo [步骤1] 备份当前数据
call backup_windows.bat

echo [步骤2] 拉取最新代码
git pull

echo [步骤3] 重新构建镜像
docker-compose build --no-cache

echo [步骤4] 重启服务
docker-compose down
docker-compose up -d

echo [步骤5] 验证服务
timeout /t 30
docker logs sage-mcp --tail 20

echo [完成] 更新完成
```

## 结论

本指南提供了Sage项目在Windows 10环境下的完整移植方案。关键适配点包括：

1. **路径系统**: Windows路径格式适配
2. **Docker集成**: 利用Docker Desktop的Windows集成
3. **Claude Code CLI配置**: Windows特定的配置文件路径
4. **Hooks系统**: Windows批处理脚本适配
5. **环境变量**: Windows环境变量设置方式

通过遵循本指南，Windows 10用户可以成功部署和使用Sage记忆管理系统，实现与Claude Code CLI的无缝集成。

## 后续维护建议

1. **定期备份**: 建议每日自动备份数据库和配置
2. **日志监控**: 设置日志轮转避免磁盘空间耗尽
3. **性能监控**: 定期检查容器资源使用情况
4. **安全更新**: 及时更新Docker镜像和依赖包
5. **功能测试**: 定期验证MCP连接和记忆功能

---

*本指南基于Sage项目当前架构分析生成，适用于Windows 10 + Docker Desktop + Claude Code CLI环境。*