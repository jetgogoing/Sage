# 执行报告：修复 sage MCP 连接问题

## 任务概述
- **目标**：解决 sage MCP 服务连接失败问题
- **需求来源**：用户尝试使用 `mcp__sage__save_conversation` 功能时遇到连接错误
- **执行时间**：2025-01-17 01:54:03

## 问题描述
sage MCP 服务在调用保存对话功能时报错：`[Errno 54] Connection reset by peer`，表明数据库连接被拒绝。

## 修改范围与文件变动

### 1. 修改文件
- **文件**：`/Users/jet/sage/.mcp.json`
- **行号**：9-22
- **修改原因**：添加正确命名的数据库环境变量

### 具体变更内容
```json
// 原配置只有 SAGE_DB_* 变量
"env": {
  "SAGE_DB_HOST": "localhost",
  "SAGE_DB_PORT": "5432",
  "SAGE_DB_NAME": "sage_memory",
  "SAGE_DB_USER": "sage",
  "SAGE_DB_PASSWORD": "sage",
  // 新增 DB_* 变量
  "DB_HOST": "localhost",
  "DB_PORT": "5432",
  "DB_NAME": "sage_memory",
  "DB_USER": "sage",
  "DB_PASSWORD": "sage",
  "SAGE_LOG_DIR": "/Users/jet/sage/logs",
  "PYTHONPATH": "/Users/jet/sage"
}
```

## 问题记录与解决方法

### 根本原因分析
1. **环境变量命名不匹配**
   - Python 脚本（sage_mcp_stdio_single.py）期望读取 `DB_HOST`、`DB_USER` 等环境变量
   - MCP 配置文件只提供了 `SAGE_DB_HOST`、`SAGE_DB_USER` 等变量
   
2. **密码默认值错误**
   - 脚本中的默认密码为 `sage123`（第 645 行）
   - 实际数据库密码为 `sage`
   - 由于找不到正确的环境变量，脚本使用了错误的默认密码

### 解决方案
在 `.mcp.json` 配置文件中添加了正确命名的环境变量（DB_*），确保脚本能读取到正确的数据库连接信息。

## 后续建议或注意事项

1. **立即操作**：用户需要重启 Claude 应用程序以重新加载 MCP 配置
2. **代码优化建议**：
   - 考虑统一环境变量命名规范，避免混淆
   - 在 sage_mcp_stdio_single.py 中添加更详细的错误日志
   - 移除冗余的 `SAGE_DB_*` 环境变量，保持配置简洁
3. **文档建议**：在项目 README 中明确说明所需的环境变量及其用途

## 测试验证
修复后需要验证：
1. 重启 Claude 应用程序
2. 再次尝试 `mcp__sage__save_conversation` 功能
3. 确认数据库连接成功，功能正常运行