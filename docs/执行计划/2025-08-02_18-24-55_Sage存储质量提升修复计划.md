# Sage 存储质量提升修复计划

生成时间：2025-08-02 18:24:55

## 任务概述

**目标**：提升 Sage 系统存储质量从 82/100 到 95+/100

**需求来源**：用户要求使用 ZEN 多模型协作深度分析存储链路质量问题

## 问题诊断结果

通过 R1 和 qwen3-coder 深度分析，发现以下关键问题：

1. **P0 - 事务一致性缺失**（3-5%数据丢失风险）
   - 向量化和数据库保存不在同一事务中
   - manager.py 第94-121行存在原子性问题

2. **P1 - 文本截断**（15-20%语义损失）  
   - security_utils.py 第229行强制截断至50000字符
   - 长对话内容丢失重要上下文

3. **P1 - 去重算法过简**（2-3%更新丢失）
   - storage.py 第70行仅使用内容哈希
   - 缺少时间维度，删除了有价值的更新

4. **P2 - 思维链捕获不完整**
   - sage_stop_hook.py 仅处理助手消息中的thinking
   - 用户消息中的思维过程被忽略

5. **P2 - 元数据大小未检查**
   - 可能导致数据库插入失败

## 修改范围与文件变动

### Phase 1：事务一致性修复（第1-2天）

**文件：sage_core/memory/manager.py**
- 行94-121：重构 _save_without_transaction 方法
- 新增：显式事务包装器
- 修改原因：确保向量化和存储的原子性

**文件：sage_core/memory/storage.py**  
- 行46-151：增强 save 方法的事务支持
- 新增：save_in_transaction 方法
- 修改原因：支持事务内保存

### Phase 2：高优先级优化（第3-5天）

**文件：sage_core/memory/storage.py**
- 行70-91：改进去重算法
- 新增：时间窗口和相似度检查
- 修改原因：避免删除有价值的更新

**文件：hooks/scripts/sage_stop_hook.py**
- 行371-373：扩展思维链捕获
- 新增：处理用户消息中的thinking
- 修改原因：完整捕获对话思维过程

**文件：hooks/scripts/security_utils.py**
- 行229：移除硬编码截断限制
- 新增：分块处理逻辑
- 修改原因：保持长文本完整性

### Phase 3：长期增强（第6-14天）

**文件：sage_core/memory/vectorizer.py**
- 新增：分块向量化方法
- 新增：向量聚合索引
- 修改原因：支持超长文本向量化

**文件：sage_core/memory/storage.py**
- 新增：元数据验证方法
- 新增：压缩存储选项
- 修改原因：防止元数据过大导致失败

## 运行和测试输出摘要

### 数据质量分析结果
```
存储质量评分：82/100
- 数据完整性：85/100
- 语义保真度：75/100  
- 查询性能：88/100
- 存储效率：80/100
```

### 垃圾记录清理结果
```
总记录数：217
垃圾记录：153（70.5%）
- 空内容：89条
- 纯工具调用：42条
- 重复记录：22条
有价值记录：64条（29.5%）
```

### 随机样本展示
展示了3条完整记录，验证了：
- 向量维度正确（4096维）
- 元数据结构完整
- 但存在大量低价值记录

## 问题记录与解决方法

1. **问题**：Gemini 模型不在 ZEN 工具支持列表中
   **解决**：改用 openai/gpt-4.1 完成计划制定

2. **问题**：planner 工具需要步骤间深入思考
   **解决**：每步后进行战略反思再继续

3. **问题**：O3 mini 审核发现实施细节不足
   **解决**：补充技术实现细节和风险管理方案

## 后续建议和注意事项

### 基于 O3 mini 审核的优化建议

1. **实施顺序调整**
   - 第1-4天：事务一致性（含完整测试）
   - 第5-9天：文本截断 + 智能去重
   - 第10-13天：思维链完整捕获
   - 第14-18天：元数据优化 + 性能调优

2. **风险缓解措施**
   - 每个阶段前进行完整数据备份
   - 建立 A/B 测试环境
   - 实施灰度发布策略
   - 设置自动回滚机制

3. **监控指标增强**
   - 实时数据完整性监控
   - 语义损失率追踪
   - 查询性能 P99 监控
   - 存储增长趋势分析

4. **技术债务管理**
   - 建立定期代码审查机制
   - 持续优化查询性能
   - 定期清理低价值记录
   - 更新文档和测试用例

## 预期成果

- 存储质量：82/100 → 95+/100
- 数据丢失：3-5% → 0%
- 语义损失：15-20% → <1%
- 查询延迟：不稳定 → <500ms
- 有价值记录占比：29.5% → >80%