# Sage 开发全过程时间轴 & 架构/特性/使用指南

> 通过解析 `docs.zip` 中约 40 份带时间戳的执行/分析报告，以及无时间戳的架构文档，整理得到下列内容。

---

## 🗓️ 开发时间轴（2025‑07‑12 → 2025‑07‑13）

- **2025-07-12 04-10-39** — Sage MCP 轻量化记忆系统代码分析报告
- **2025-07-12 04-19-37** — 修复 API 密钥安全问题执行报告
- **2025-07-12 10-33-25** — 创建环境变量配置文件执行报告
- **2025-07-12 11-47-09** — 配置 Claude 命令默认带记忆功能执行报告
- **2025-07-12 12-22-11** — 修复Claude命令配置问题执行报告
- **2025-07-12 12-37-53** — 设计智能包装器解决方案执行报告
- **2025-07-12 12-54-34** — 实现自检系统功能执行报告
- **2025-07-12 13-00-35** — 执行报告：跨平台兼容性分析与优化
- **2025-07-12 13-14-34** — 执行报告：跨平台兼容性高质量执行
- **2025-07-12 14-06-39** — 实现 claude-mem v3 阶段1 - 执行报告
- **2025-07-12 14-22-36** — 阶段1完整测试通过 - 执行报告
- **2025-07-12 15-02-29** — Sage MCP 阶段1架构兼容性修复 - 执行报告
- **2025-07-12 15-13-13** — Sage MCP 阶段2世界级智能系统 - 执行报告
- **2025-07-12 15-23-23** — Sage MCP 阶段2执行质量深度审查报告
- **2025-07-12 16-03-12** — 阶段2问题修复执行报告
- **2025-07-12 16-06-17** — 阶段2问题修复完成总结报告
- **2025-07-12 16-20-18** — Claude-Mem 智能记忆系统 - 阶段1至阶段2完成总结报告
- **2025-07-12 17-08-33** — 阶段3 用户控制功能完成报告
- **2025-07-12 17-50-38** — 阶段3 核心功能完善报告
- **2025-07-12 18-15-12** — 阶段4：测试、优化与完成 - 执行报告
- **2025-07-13 00-48-44** — 任务执行报告：记忆保存Bug排查与修复
- **2025-07-13 01-10-26** — 任务执行报告：递归保护机制深度分析与修复
- **2025-07-13 01-23-35** — 递归保护最终修复方案
- **2025-07-13 02-10-14** — 递归保护问题最终解决方案
- **2025-07-13 02-27-12** — 阶段4回滚完成报告
- **2025-07-13 03-40-09** — Sage 全局记忆系统重构执行报告
- **2025-07-13 04-00-40** — Sage 记忆注入失败问题排查报告
- **2025-07-13 14-45-23** — MCP 协议实现分析报告
- **2025-07-13 15-07-38** — 阶段1: MCP服务器基础框架实现 - 执行报告
- **2025-07-13 16-04-55** — 智能检索系统恢复与增强 - 执行报告
- **2025-07-13 16-15-30** — 阶段1向后兼容性分析报告
- **2025-07-13 16-26-11** — 阶段2 Docker容器化与配置系统重构执行报告
- **2025-07-13 16-39-30** — 阶段3 数据库兼容性与迁移工具执行报告
- **2025-07-13 16-56-05** — 阶段4 Claude Code MCP集成与协议实现执行报告
- **2025-07-13 17-15-13** — Claude Code 记忆测试准备完成报告
- **2025-07-13 17-24-50** — Claude Code记忆测试指南完善报告
- **2025-07-13 17-52-41** — MCP协议修复报告
- **2025-07-13 21-58-42** — Sage MCP 阶段4完成及自动记忆集成执行报告
- **2025-07-13 22-00-54** — Sage MCP 阶段4完整执行报告
- **2025-07-13 22-26-57** — Sage MCP 自动上下文注入机制深度分析报告

---

## 🧱 最终项目架构（阶段 4 完成状态）

```
Claude Code (MCP Client)
   │  HTTP(MCP)
   ▼
Sage MCP Server   ←─┐
   │ get_context      │ save_conversation
   ▼                  │
PostgreSQL + pgvector │
   ▲                  │
   └─ 深度压缩 (DeepSeek) / Reranker (Qwen)
```

| 层级 | 组件 | 说明 |
|------|------|------|
| 接口 | MCP HTTP | `/mcp`, `/tools/get_context`, `/tools/save_conversation` |
| 记忆注入 | Prompt `auto_context_injection` | 每轮对话前自动检索并注入历史 |
| 检索 | Qwen3‑Embedding‑8B + pgvector | 4096 维余弦搜索 |
| 精排 | Qwen3‑Reranker‑8B (可选) | 语义质量优先 |
| 压缩 | DeepSeek‑V2.5 (可配) | 动态触发 LLM 摘要 |
| 存储 | PostgreSQL (Docker) | conversations 表 + embedding |

---

## ✨ 项目特点

1. **真正无感记忆** – 用户在任何目录对话，历史自动被检索与保存  
2. **Prompt‑level 自动注入** – 通过 MCP prompts，零额外函数调用  
3. **多模型可插拔** – 嵌入 / 重排序 / 摘要模型全部 `.env` 配置  
4. **跨平台部署** – Docker 一键启动，macOS / Windows / Linux 通用  
5. **安全合规** – 本地运行，API Key 加密存储，不暴露外网端口  

---

## 🛠️ 使用指南

```bash
# 1. 克隆并部署
git clone https://github.com/jetgogoing/Sage.git
cd Sage
cp .env.example .env   # 填写 SILICONFLOW_API_KEY 与模型名
docker compose up -d   # 启动 Sage MCP + Postgres

# 2. 注册一次 MCP 服务
claude mcp add sage http://localhost:17800

# 3. 体验无感记忆
claude
> 我家的猫叫面团
claude
> 你还记得我猫叫什么吗？
# Claude 会回答 “面团”
```

> **可选**：修改 `.env`  
> ```dotenv
> EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B
> RERANKER_MODEL=Qwen/Qwen3-Reranker-8B
> SUMMARY_MODEL=deepseek-ai/DeepSeek-V2.5
> ```

---

## 🔧 后续优化建议

- **集成 `memory_fusion_prompt_programming.txt`** 提升编程场景摘要质量  
- **动态压缩开关** – 检索片段长度 > 5000 tokens 时才调用 DeepSeek  
- 引入查询级缓存，减少重复摘要调用  
- 为不同技术栈制作领域特定模板，提高上下文精准度  

---

> 以上即为 Sage 项目 48 小时内的完整开发轨迹、当前架构概览、核心特性与使用入门。
